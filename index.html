<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión - Pintura Electrostática</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .modal { transition: opacity 0.3s ease; }
        .remision-id, .cliente-id, .item-ref { font-family: monospace; font-size: 0.8rem; background-color: #e5e7eb; padding: 2px 6px; border-radius: 4px; color: #4b5563; }
        .item-row:not(:last-child) { border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1rem; }
        .tab-btn { transition: all 0.2s ease-in-out; border-bottom: 4px solid transparent; }
        .tab-btn.active { border-bottom-color: #4f46e5; color: #111827; }
        .dashboard-tab-btn { transition: all 0.2s ease-in-out; border-bottom: 2px solid transparent; }
        .dashboard-tab-btn.active { border-color: #4f46e5; color: #4f46e5; }
        .btn-disabled { cursor: not-allowed; background-color: #9ca3af !important; }
        .remision-anulada { background-color: #fee2e2; border-left: 4px solid #ef4444; }
        .status-badge { font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 9999px; font-weight: 600; }
        .status-recibido { background-color: #e0e7ff; color: #4338ca; }
        .status-en-proceso { background-color: #fef3c7; color: #b45309; }
        .status-procesado { background-color: #dbeafe; color: #1d4ed8; }
        .status-entregado { background-color: #dcfce7; color: #166534; }
        .payment-status { font-size: 0.7rem; padding: 0.1rem 0.5rem; border-radius: 9999px; font-weight: 600; border-width: 1px; }
        .payment-pagado { background-color: #dcfce7; color: #166534; border-color: #166534; }
        .payment-abono { background-color: #fef9c3; color: #a16207; border-color: #a16207; }
        .payment-pendiente { background-color: #fee2e2; color: #991b1b; border-color: #991b1b; }
        .search-results {
            position: absolute;
            z-index: 10;
            width: 100%;
            background-color: white;
            border: 1px solid #d1d5db; /* gray-300 */
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            margin-top: -2px;
            max-height: 200px;
            overflow-y: auto;
        }
        .search-result-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
        }
        .search-result-item:hover {
            background-color: #f3f4f6; /* gray-100 */
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-md">
            <form id="login-form" class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesión</h2>
                <div class="space-y-4">
                    <input type="email" id="login-email" placeholder="Correo Electrónico" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <input type="password" id="login-password" placeholder="Contraseña" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Ingresar</button>
                </div>
                <p class="text-center mt-4 text-sm">¿No tienes una cuenta? <a href="#" id="show-register-link" class="font-semibold text-indigo-600 hover:underline">Regístrate aquí</a></p>
            </form>

            <form id="register-form" class="hidden bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6">Crear Cuenta</h2>
                <div class="space-y-4">
                    <input type="text" id="register-name" placeholder="Nombre Completo" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <input type="tel" id="register-phone" placeholder="Celular" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <input type="email" id="register-email" placeholder="Correo Electrónico" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <input type="password" id="register-password" placeholder="Contraseña (mín. 6 caracteres)" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <div><label for="register-dob" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label><input type="date" id="register-dob" class="w-full p-3 border border-gray-300 rounded-lg mt-1" required></div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Registrarse</button>
                </div>
                 <p class="text-center mt-4 text-sm">¿Ya tienes una cuenta? <a href="#" id="show-login-link" class="font-semibold text-indigo-600 hover:underline">Inicia sesión</a></p>
            </form>
        </div>
    </div>

    <div id="app-view" class="hidden min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <header class="mb-6 flex flex-col sm:flex-row justify-between sm:items-center gap-4 sm:gap-0">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Sistema de Gestión Integral</h1>
                    <p id="user-info" class="text-gray-600 mt-1">Cargando usuario...</p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="summary-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Resumen</button>
                    <button id="logout-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Cerrar Sesión</button>
                </div>
            </header>

            <div class="border-b border-gray-200 mb-6">
                <nav id="main-nav" class="-mb-px flex space-x-6 overflow-x-auto">
                    <button id="tab-remisiones" class="tab-btn active py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap">Remisiones</button>
                    <button id="tab-facturacion" class="tab-btn py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap">Facturación</button>
                    <button id="tab-clientes" class="tab-btn py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap">Clientes</button>
                    <button id="tab-items" class="tab-btn py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap">Ítems</button>
                    <button id="tab-colores" class="tab-btn py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap">Colores</button>
                    <button id="tab-gastos" class="tab-btn py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap">Gastos</button>
                    <button id="tab-proveedores" class="tab-btn py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap">Proveedores</button>
                    <button id="tab-empleados" class="tab-btn py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap hidden">Empleados</button>
                </nav>
            </div>

            <main>
                <div id="view-remisiones"></div>
                <div id="view-facturacion" class="hidden"></div>
                <div id="view-clientes" class="hidden"></div>
                <div id="view-items" class="hidden"></div>
                <div id="view-colores" class="hidden"></div>
                <div id="view-gastos" class="hidden"></div>
                <div id="view-proveedores" class="hidden"></div>
                <div id="view-empleados" class="hidden"></div>
            </main>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="modal-content-wrapper" class="w-full">
            <div id="modal-content" class="bg-white rounded-lg p-6 shadow-xl w-11/12 max-w-sm mx-auto text-center">
                </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, orderBy, onSnapshot, deleteDoc, updateDoc, addDoc, runTransaction, arrayUnion } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-functions.js";

        
        // --- INICIALIZACIÓN Y CONFIGURACIÓN ---
        const firebaseConfig = {
            apiKey: "AIzaSyAOeIv-PnETZIs5NFrsxsBnqf2_Gt6hbKM",
            authDomain: "prismacolorsas.firebaseapp.com",
            storageBucket: "prismacolorsas.appspot.com",
            projectId: "prismacolorsas",
            messagingSenderId: "907757501037",
            appId: "1:907757501037:web:ab61eb771e12add9a29d64",
            measurementId: "G-T2RKG90GC5"
        };
        let app, auth, db, storage, functions;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            functions = getFunctions(app);
        } catch (e) { console.error("Error al inicializar Firebase.", e); showModalMessage("Error de Configuración de Firebase."); }
        
        // --- VISTAS Y ESTADO GLOBAL ---
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        let currentUser = null;
        let currentUserData = null;
        let allItems = [];
        let allColores = [];
        let allClientes = [];
        let allProveedores = [];
        let allGastos = [];
        let allRemisiones = [];
        let profitLossChart = null;
        let dynamicElementCounter = 0;
        const ESTADOS_REMISION = ['Recibido', 'En Proceso', 'Procesado', 'Entregado'];
        const ALL_MODULES = ['remisiones', 'facturacion', 'clientes', 'items', 'colores', 'gastos', 'proveedores', 'empleados'];
        const OBRAS_DOCUMENT_TYPES = [
            { id: 'cedula_obra', name: 'Cédula' },
            { id: 'hoja_vida_obra', name: 'Hoja de vida' },
            { id: 'contrato_obra', name: 'Contrato' },
            { id: 'afiliacion_eps_obra', name: 'Afiliación EPS' },
            { id: 'afiliacion_arl_obra', name: 'Afiliación ARL' },
            { id: 'certificado_arl_obra', name: 'Certificado ARL' },
            { id: 'examen_medico_obra', name: 'Examen Médico', requiresDate: true, validityMonths: 12 },
            { id: 'resolucion_salud_obra', name: 'Resolución Centro de Salud' },
            { id: 'policia_obra', name: 'Policía Nacional' },
            { id: 'curso_alturas_obra', name: 'Curso de Alturas', requiresDate: true, validityMonths: 18 },
            { id: 'constancia_alturas_obra', name: 'Constancia Curso de Alturas', requiresDate: true, validityMonths: 18 },
            { id: 'perfil_cargo_obra', name: 'Perfil del Cargo' },
            { id: 'induccion_empresa_obra', name: 'Inducción a la Empresa' },
        ];
        const RRHH_DOCUMENT_TYPES = [
            { id: 'contrato_rrhh', name: 'Contrato' },
            { id: 'cedula_rrhh', name: 'Cédula (PDF)' },
            { id: 'examenMedico_rrhh', name: 'Examen Médico', requiresDate: true, validityMonths: 12 },
            { id: 'certificadoARL_rrhh', name: 'Certificado ARL' },
            { id: 'certificadoEPS_rrhh', name: 'Certificado EPS' },
            { id: 'certificadoAFP_rrhh', name: 'Certificado AFP' },
        ];
        const RRHH_PAYMENT_TYPES = [
            { id: 'prima', name: 'Prima' },
            { id: 'liquidacion', name: 'Liquidación' },
        ];


        // --- MANEJO DE AUTENTICACIÓN Y VISTAS ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    document.getElementById('user-info').textContent = `Usuario: ${currentUserData.nombre} (${currentUserData.role})`;
                }
                authView.classList.add('hidden');
                appView.classList.remove('hidden');
                loadInitialData();
            } else {
                currentUser = null;
                currentUserData = null;
                authView.classList.remove('hidden');
                appView.classList.add('hidden');
            }
        });

        function updateUIVisibility(userData) {
            const nav = document.getElementById('main-nav');
            if (!userData || !nav) return;

            const permissions = userData.permissions || {};
            const isAdmin = userData.role && userData.role.toLowerCase() === 'admin';
            const isPlanta = userData.role && userData.role.toLowerCase() === 'planta';

            ALL_MODULES.forEach(module => {
                const tab = document.getElementById(`tab-${module}`);
                if (tab) {
                    const hasPermission = isAdmin || permissions[module];
                    if (hasPermission) {
                        tab.classList.remove('hidden');
                    } else {
                        tab.classList.add('hidden');
                    }
                }
            });
            
            const summaryBtn = document.getElementById('summary-btn');
            if(summaryBtn) {
                summaryBtn.style.display = (isPlanta) ? 'none' : '';
            }

            const remisionFormContainer = document.getElementById('remision-form-container');
            const remisionListContainer = document.getElementById('remisiones-list-container');
            if (remisionFormContainer && remisionListContainer) {
                if (isPlanta) {
                    remisionFormContainer.classList.add('hidden');
                    remisionListContainer.classList.remove('lg:col-span-2');
                    remisionListContainer.classList.add('lg:col-span-3');
                } else {
                    remisionFormContainer.classList.remove('hidden');
                    remisionListContainer.classList.add('lg:col-span-2');
                    remisionListContainer.classList.remove('lg:col-span-3');
                }
            }
        }

        function loadInitialData() {
            // Cargar plantillas HTML en las vistas
            document.getElementById('view-remisiones').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-6xl mx-auto"><div id="remision-form-container" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold mb-4">Nueva Remisión</h2><form id="remision-form" class="space-y-4"><div class="relative"><input type="text" id="cliente-search-input" autocomplete="off" placeholder="Buscar y seleccionar cliente..." class="w-full p-3 border border-gray-300 rounded-lg" required><input type="hidden" id="cliente-id-hidden" name="clienteId"><div id="cliente-search-results" class="search-results hidden"></div></div><div><label for="fecha-recibido" class="block text-sm font-medium text-gray-700">Fecha Recibido</label><input type="date" id="fecha-recibido" class="w-full p-3 border border-gray-300 rounded-lg mt-1 bg-gray-100" readonly></div><div class="border-t border-b border-gray-200 py-4"><h3 class="text-lg font-semibold mb-2">Ítems de la Remisión</h3><div id="items-container" class="space-y-4"></div><button type="button" id="add-item-btn" class="mt-4 w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">+ Añadir Ítem</button></div><select id="forma-pago" class="w-full p-3 border border-gray-300 rounded-lg bg-white" required><option value="" disabled selected>Forma de Pago</option><option value="Pendiente">Pendiente</option><option value="Efectivo">Efectivo</option><option value="Nequi">Nequi</option><option value="Davivienda">Davivienda</option></select><div class="bg-gray-50 p-4 rounded-lg space-y-2"><div class="flex justify-between items-center"><span class="font-medium">Subtotal:</span><span id="subtotal" class="font-bold text-lg">$ 0</span></div><div class="flex justify-between items-center"><label for="incluir-iva" class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="incluir-iva" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><span>Incluir IVA (19%)</span></label><span id="valor-iva" class="font-medium text-gray-600">$ 0</span></div><hr><div class="flex justify-between items-center text-xl"><span class="font-bold">TOTAL:</span><span id="valor-total" class="font-bold text-indigo-600">$ 0</span></div></div><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Guardar y Enviar Remisión</button></form></div><div id="remisiones-list-container" class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 flex-wrap gap-4"><h2 class="text-xl font-semibold">Historial de Remisiones</h2><div class="flex items-center gap-2 flex-wrap"><select id="filter-remisiones-month" class="p-2 border rounded-lg bg-white"></select><select id="filter-remisiones-year" class="p-2 border rounded-lg bg-white"></select><input type="search" id="search-remisiones" placeholder="Buscar..." class="p-2 border rounded-lg w-full sm:w-40"></div></div><div id="remisiones-list" class="space-y-3"><p id="loading-remisiones" class="text-center text-gray-500 py-8">Cargando...</p></div></div></div>`;
            document.getElementById('view-facturacion').innerHTML = `<div class="bg-white p-6 rounded-xl shadow-md max-w-6xl mx-auto"><h2 class="text-2xl font-semibold mb-4">Gestión de Facturación</h2><div class="border-b border-gray-200 mb-6"><nav id="facturacion-nav" class="-mb-px flex space-x-6"><button id="tab-pendientes" class="dashboard-tab-btn active py-3 px-1 font-semibold">Pendientes</button><button id="tab-realizadas" class="dashboard-tab-btn py-3 px-1 font-semibold">Realizadas</button></nav></div><div id="view-pendientes"><h3 class="text-xl font-semibold text-gray-800 mb-4">Remisiones Pendientes de Facturar</h3><div id="facturacion-pendientes-list" class="space-y-3"></div></div><div id="view-realizadas" class="hidden"><h3 class="text-xl font-semibold text-gray-800 mb-4">Remisiones Facturadas</h3><div id="facturacion-realizadas-list" class="space-y-3"></div></div></div>`;
            document.getElementById('view-clientes').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-6xl mx-auto"><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold mb-4">Añadir Nuevo Cliente</h2><form id="add-cliente-form" class="space-y-4"><input type="text" id="nuevo-cliente-nombre" placeholder="Nombre Completo" class="w-full p-3 border border-gray-300 rounded-lg" required><input type="email" id="nuevo-cliente-email" placeholder="Correo Electrónico" class="w-full p-3 border border-gray-300 rounded-lg" required><input type="tel" id="nuevo-cliente-telefono" placeholder="Teléfono" class="w-full p-3 border border-gray-300 rounded-lg" required><input type="text" id="nuevo-cliente-nit" placeholder="NIT (Opcional)" class="w-full p-3 border border-gray-300 rounded-lg"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">Registrar Cliente</button></form></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Clientes Registrados</h2><input type="search" id="search-clientes" placeholder="Buscar cliente..." class="p-2 border rounded-lg"></div><div id="clientes-list" class="space-y-3"><p id="loading-clientes" class="text-center text-gray-500 py-8">Cargando...</p></div></div></div>`;
            document.getElementById('view-proveedores').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-6xl mx-auto"><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold mb-4">Añadir Nuevo Proveedor</h2><form id="add-proveedor-form" class="space-y-4"><input type="text" id="nuevo-proveedor-nombre" placeholder="Nombre del Proveedor" class="w-full p-3 border border-gray-300 rounded-lg" required><input type="text" id="nuevo-proveedor-contacto" placeholder="Nombre de Contacto (Opcional)" class="w-full p-3 border border-gray-300 rounded-lg"><input type="tel" id="nuevo-proveedor-telefono" placeholder="Teléfono" class="w-full p-3 border border-gray-300 rounded-lg"><input type="email" id="nuevo-proveedor-email" placeholder="Correo Electrónico" class="w-full p-3 border border-gray-300 rounded-lg"><button type="submit" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-colors">Registrar Proveedor</button></form></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Proveedores Registrados</h2><input type="search" id="search-proveedores" placeholder="Buscar proveedor..." class="p-2 border rounded-lg"></div><div id="proveedores-list" class="space-y-3"><p id="loading-proveedores" class="text-center text-gray-500 py-8">Cargando...</p></div></div></div>`;
            document.getElementById('view-items').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-6xl mx-auto"><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold mb-4">Añadir Nuevo Ítem</h2><form id="add-item-form" class="space-y-4"><input type="text" id="nuevo-item-ref" placeholder="Referencia (ej. P-001)" class="w-full p-3 border border-gray-300 rounded-lg" required><input type="text" id="nuevo-item-desc" placeholder="Descripción del Ítem o Servicio" class="w-full p-3 border border-gray-300 rounded-lg" required><button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors">Registrar Ítem</button></form></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Catálogo de Ítems</h2><input type="search" id="search-items" placeholder="Buscar por ref. o desc..." class="p-2 border rounded-lg"></div><div id="items-list" class="space-y-3"><p id="loading-items" class="text-center text-gray-500 py-8">Cargando...</p></div></div></div>`;
            document.getElementById('view-colores').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-6xl mx-auto"><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold mb-4">Añadir Nuevo Color</h2><form id="add-color-form" class="space-y-4"><input type="text" id="nuevo-color-nombre" placeholder="Nombre del Color (ej. RAL 7016)" class="w-full p-3 border border-gray-300 rounded-lg" required><button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors">Registrar Color</button></form></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Catálogo de Colores</h2><input type="search" id="search-colores" placeholder="Buscar color..." class="p-2 border rounded-lg"></div><div id="colores-list" class="space-y-3"><p id="loading-colores" class="text-center text-gray-500 py-8">Cargando...</p></div></div></div>`;
            document.getElementById('view-gastos').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 max-w-6xl mx-auto"><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold mb-4">Nuevo Gasto</h2><form id="add-gasto-form" class="space-y-4"><div><label for="gasto-fecha">Fecha</label><input type="date" id="gasto-fecha" class="w-full p-3 border border-gray-300 rounded-lg mt-1" required></div><div class="relative"><label for="proveedor-search-input">Proveedor</label><input type="text" id="proveedor-search-input" autocomplete="off" placeholder="Buscar proveedor..." class="w-full p-3 border border-gray-300 rounded-lg mt-1" required><input type="hidden" id="proveedor-id-hidden" name="proveedorId"><div id="proveedor-search-results" class="search-results hidden"></div></div><input type="text" id="gasto-factura" placeholder="N° de Factura (Opcional)" class="w-full p-3 border border-gray-300 rounded-lg"><input type="text" id="gasto-valor-total" inputmode="numeric" placeholder="Valor Total" class="w-full p-3 border border-gray-300 rounded-lg" required><label class="flex items-center space-x-2"><input type="checkbox" id="gasto-iva" class="h-4 w-4 rounded border-gray-300"><span>IVA del 19% ya está incluido en el valor total</span></label><div><label for="gasto-fuente">Fuente del Pago</label><select id="gasto-fuente" class="w-full p-3 border border-gray-300 rounded-lg mt-1 bg-white" required><option value="Efectivo">Efectivo</option><option value="Nequi">Nequi</option><option value="Davivienda">Davivienda</option></select></div><button type="submit" class="w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-700">Registrar Gasto</button></form></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><div class="flex justify-between items-center mb-4 flex-wrap gap-2"><h2 class="text-xl font-semibold">Historial de Gastos</h2><div class="flex items-center gap-2"><select id="filter-gastos-month" class="p-2 border rounded-lg bg-white"></select><select id="filter-gastos-year" class="p-2 border rounded-lg bg-white"></select><input type="search" id="search-gastos" placeholder="Buscar..." class="p-2 border rounded-lg w-40"></div></div><div id="gastos-list" class="space-y-3"><p id="loading-gastos" class="text-center text-gray-500 py-8">Cargando...</p></div></div></div>`;
            document.getElementById('view-empleados').innerHTML = `<div class="bg-white p-6 rounded-xl shadow-md max-w-4xl mx-auto"><h2 class="text-xl font-semibold mb-4">Gestión de Empleados</h2><div id="empleados-list" class="space-y-3"></div></div>`;
            
            updateUIVisibility(currentUserData);
            loadClientes();
            loadProveedores();
            loadItems();
            loadColores();
            loadRemisiones();
            loadGastos();
            if (currentUserData && currentUserData.role === 'admin') loadEmpleados();
            setupEventListeners();
        }

        // --- LÓGICA DE LOGIN/REGISTRO/LOGOUT ---
        document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
        document.getElementById('show-login-link').addEventListener('click', (e) => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
        loginForm.addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; signInWithEmailAndPassword(auth, email, password).catch(error => { console.error(error); showModalMessage("Error: " + error.message); }); });
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('register-name').value;
            const telefono = document.getElementById('register-phone').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const dob = document.getElementById('register-dob').value;
            showModalMessage("Registrando...", true);
            try {
                const usersCollection = collection(db, "users");
                const existingUsers = await getDocs(query(usersCollection));
                const isFirstUser = existingUsers.empty;
                const role = isFirstUser ? 'admin' : 'planta';
                const permissions = { remisiones: true, facturacion: isFirstUser, clientes: !isFirstUser, items: !isFirstUser, colores: !isFirstUser, gastos: !isFirstUser, proveedores: !isFirstUser, empleados: isFirstUser };

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await setDoc(doc(db, "users", user.uid), { nombre, email, telefono, dob, role, creadoEn: new Date(), permissions });
                hideModal();
                showModalMessage("¡Registro exitoso! Ahora puedes iniciar sesión.", false, 3000);
                registerForm.reset();
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            } catch (error) { hideModal(); console.error(error); showModalMessage("Error de registro: " + error.message); }
        });
        document.getElementById('logout-btn').addEventListener('click', () => { signOut(auth); });

        // --- LÓGICA DE NAVEGACIÓN Y EVENTOS ---
        function setupEventListeners() {
            const tabs = { remisiones: document.getElementById('tab-remisiones'), facturacion: document.getElementById('tab-facturacion'), clientes: document.getElementById('tab-clientes'), items: document.getElementById('tab-items'), colores: document.getElementById('tab-colores'), gastos: document.getElementById('tab-gastos'), proveedores: document.getElementById('tab-proveedores'), empleados: document.getElementById('tab-empleados') };
            const views = { remisiones: document.getElementById('view-remisiones'), facturacion: document.getElementById('view-facturacion'), clientes: document.getElementById('view-clientes'), items: document.getElementById('view-items'), colores: document.getElementById('view-colores'), gastos: document.getElementById('view-gastos'), proveedores: document.getElementById('view-proveedores'), empleados: document.getElementById('view-empleados') };
            Object.keys(tabs).forEach(key => { if(tabs[key]) tabs[key].addEventListener('click', () => switchView(key, tabs, views)) });
            
            const facturacionPendientesTab = document.getElementById('tab-pendientes');
            const facturacionRealizadasTab = document.getElementById('tab-realizadas');
            const facturacionPendientesView = document.getElementById('view-pendientes');
            const facturacionRealizadasView = document.getElementById('view-realizadas');

            if (facturacionPendientesTab) {
                facturacionPendientesTab.addEventListener('click', () => {
                    facturacionPendientesTab.classList.add('active');
                    facturacionRealizadasTab.classList.remove('active');
                    facturacionPendientesView.classList.remove('hidden');
                    facturacionRealizadasView.classList.add('hidden');
                });
            }
            if (facturacionRealizadasTab) {
                facturacionRealizadasTab.addEventListener('click', () => {
                    facturacionRealizadasTab.classList.add('active');
                    facturacionPendientesTab.classList.remove('active');
                    facturacionRealizadasView.classList.remove('hidden');
                    facturacionPendientesView.classList.add('hidden');
                });
            }

            document.getElementById('add-color-form').addEventListener('submit', async (e) => { e.preventDefault(); const nuevoColor = { nombre: document.getElementById('nuevo-color-nombre').value, creadoEn: new Date() }; showModalMessage("Registrando color...", true); try { await addDoc(collection(db, "colores"), nuevoColor); e.target.reset(); hideModal(); showModalMessage("¡Color registrado!", false, 2000); } catch (error) { console.error(error); hideModal(); showModalMessage("Error al registrar color."); } });
            document.getElementById('add-item-form').addEventListener('submit', async (e) => { e.preventDefault(); const nuevoItem = { referencia: document.getElementById('nuevo-item-ref').value, descripcion: document.getElementById('nuevo-item-desc').value, creadoEn: new Date() }; showModalMessage("Registrando ítem...", true); try { await addDoc(collection(db, "items"), nuevoItem); e.target.reset(); hideModal(); showModalMessage("¡Ítem registrado!", false, 2000); } catch (error) { console.error(error); hideModal(); showModalMessage("Error al registrar ítem."); } });
            document.getElementById('add-cliente-form').addEventListener('submit', async (e) => { e.preventDefault(); const nuevoCliente = { nombre: document.getElementById('nuevo-cliente-nombre').value, email: document.getElementById('nuevo-cliente-email').value, telefono: document.getElementById('nuevo-cliente-telefono').value, nit: document.getElementById('nuevo-cliente-nit').value || '', creadoEn: new Date() }; showModalMessage("Registrando cliente...", true); try { await addDoc(collection(db, "clientes"), nuevoCliente); e.target.reset(); hideModal(); showModalMessage("¡Cliente registrado!", false, 2000); } catch (error) { console.error(error); hideModal(); showModalMessage("Error al registrar cliente."); } });
            document.getElementById('add-proveedor-form').addEventListener('submit', handleProveedorSubmit);
            document.getElementById('add-gasto-form').addEventListener('submit', handleGastoSubmit);
            document.getElementById('remision-form').addEventListener('submit', handleRemisionSubmit);
            document.getElementById('add-item-btn').addEventListener('click', () => {
                const itemsContainer = document.getElementById('items-container');
                if (itemsContainer) itemsContainer.appendChild(createItemElement());
            });
            const ivaCheckbox = document.getElementById('incluir-iva');
            if(ivaCheckbox) ivaCheckbox.addEventListener('input', calcularTotales);
            document.getElementById('summary-btn').addEventListener('click', showDashboardModal);

            // Listeners para buscadores
            document.getElementById('search-remisiones').addEventListener('input', renderRemisiones);
            document.getElementById('search-clientes').addEventListener('input', renderClientes);
            document.getElementById('search-proveedores').addEventListener('input', renderProveedores);
            document.getElementById('search-items').addEventListener('input', renderItems);
            document.getElementById('search-colores').addEventListener('input', renderColores);
            document.getElementById('search-gastos').addEventListener('input', renderGastos);
            
            // Listeners para filtros de fecha
            populateDateFilters('filter-remisiones');
            populateDateFilters('filter-gastos');
            document.getElementById('filter-remisiones-month').addEventListener('change', renderRemisiones);
            document.getElementById('filter-remisiones-year').addEventListener('change', renderRemisiones);
            document.getElementById('filter-gastos-month').addEventListener('change', renderGastos);
            document.getElementById('filter-gastos-year').addEventListener('change', renderGastos);
            
            // Fecha de recibido
            const fechaRecibidoInput = document.getElementById('fecha-recibido');
            if (fechaRecibidoInput) {
                fechaRecibidoInput.value = new Date().toISOString().split('T')[0];
            }

            // Listeners para formateo de moneda
            document.getElementById('view-gastos').addEventListener('focusout', (e) => { if (e.target.id === 'gasto-valor-total') { formatCurrencyInput(e.target); } });
            document.getElementById('view-gastos').addEventListener('focus', (e) => { if (e.target.id === 'gasto-valor-total') { unformatCurrencyInput(e.target); } });
            document.getElementById('view-remisiones').addEventListener('focusout', (e) => { if (e.target.classList.contains('item-valor-unitario')) { formatCurrencyInput(e.target); calcularTotales(); } });
            document.getElementById('view-remisiones').addEventListener('focus', (e) => { if (e.target.classList.contains('item-valor-unitario')) { unformatCurrencyInput(e.target); } });
        }

        function switchView(viewName, tabs, views) {
            Object.values(tabs).forEach(tab => { if(tab) tab.classList.remove('active') });
            Object.values(views).forEach(view => { if(view) view.classList.add('hidden') });
            if(tabs[viewName]) tabs[viewName].classList.add('active');
            if(views[viewName]) views[viewName].classList.remove('hidden');
        }

        // --- FUNCIONES DE CARGA Y RENDERIZADO DE DATOS ---
        function loadEmpleados() {
            const empleadosListEl = document.getElementById('empleados-list');
            if (!currentUserData || currentUserData.role !== 'admin' || !empleadosListEl) return;
            const q = query(collection(db, "users"));
            onSnapshot(q, (snapshot) => {
                const users = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                empleadosListEl.innerHTML = '';
                users.filter(u => u.id !== currentUser.uid).forEach(empleado => {
                    const el = document.createElement('div');
                    el.className = 'border p-4 rounded-lg flex justify-between items-center';
                    el.innerHTML = `
                        <div>
                            <p class="font-semibold">${empleado.nombre} <span class="text-sm font-normal text-gray-500">(${empleado.role})</span></p>
                            <p class="text-sm text-gray-600">${empleado.email}</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button data-user-json='${JSON.stringify(empleado)}' class="manage-obras-docs-btn bg-yellow-500 text-white px-3 py-1 rounded-lg text-sm font-semibold hover:bg-yellow-600">Doc. Ingreso Obras</button>
                            <button data-user-json='${JSON.stringify(empleado)}' class="manage-rrhh-docs-btn bg-green-600 text-white px-3 py-1 rounded-lg text-sm font-semibold hover:bg-green-700">Doc. Recursos Humanos</button>
                            <button data-user-json='${JSON.stringify(empleado)}' class="manage-permissions-btn bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-semibold hover:bg-blue-700">Gestionar</button>
                            <button data-uid="${empleado.id}" class="delete-user-btn bg-red-600 text-white p-2 rounded hover:bg-red-700">Eliminar</button>
                        </div>`;
                    empleadosListEl.appendChild(el);
                });
                document.querySelectorAll('.manage-obras-docs-btn').forEach(btn => btn.addEventListener('click', (e) => showObrasDocsModal(JSON.parse(e.currentTarget.dataset.userJson))));
                document.querySelectorAll('.manage-rrhh-docs-btn').forEach(btn => btn.addEventListener('click', (e) => showRRHHModal(JSON.parse(e.currentTarget.dataset.userJson))));
                document.querySelectorAll('.manage-permissions-btn').forEach(btn => btn.addEventListener('click', (e) => showPermissionsModal(JSON.parse(e.currentTarget.dataset.userJson))));
                document.querySelectorAll('.delete-user-btn').forEach(btn => { btn.addEventListener('click', async (e) => { const uid = e.target.dataset.uid; if (confirm('¿Estás seguro de que quieres eliminar este usuario?')) { await deleteDoc(doc(db, "users", uid)); showModalMessage("Usuario eliminado de Firestore.", false, 2000); } }); });
            });
        }
        function loadColores() {
            const q = query(collection(db, "colores"), orderBy("nombre", "asc"));
            onSnapshot(q, (snapshot) => {
                allColores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderColores();
            });
        }
        function renderColores() {
            const coloresListEl = document.getElementById('colores-list');
            if (!coloresListEl) return;
            const searchTerm = document.getElementById('search-colores').value.toLowerCase();
            const filtered = allColores.filter(c => c.nombre.toLowerCase().includes(searchTerm));
            
            coloresListEl.innerHTML = '';
            if (filtered.length === 0) { coloresListEl.innerHTML = '<p>No hay colores.</p>'; return; }
            filtered.forEach(color => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'border p-4 rounded-lg font-semibold';
                colorDiv.textContent = color.nombre;
                coloresListEl.appendChild(colorDiv);
            });
        }
        function loadItems() {
             const q = query(collection(db, "items"), orderBy("referencia", "asc"));
            onSnapshot(q, (snapshot) => {
                allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderItems();
            });
        }
        function renderItems() {
            const itemsListEl = document.getElementById('items-list');
            if (!itemsListEl) return;
            const searchTerm = document.getElementById('search-items').value.toLowerCase();
            const filtered = allItems.filter(i => i.referencia.toLowerCase().includes(searchTerm) || i.descripcion.toLowerCase().includes(searchTerm));

            itemsListEl.innerHTML = '';
            if (filtered.length === 0) { itemsListEl.innerHTML = '<p>No hay ítems.</p>'; return; }
            filtered.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'border p-4 rounded-lg';
                itemDiv.innerHTML = `<p class="font-semibold"><span class="item-ref">${item.referencia}</span> ${item.descripcion}</p>`;
                itemsListEl.appendChild(itemDiv);
            });
        }
        function loadClientes() {
            const q = query(collection(db, "clientes"), orderBy("nombre", "asc"));
            onSnapshot(q, (snapshot) => {
                allClientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderClientes();
                setupSearchInputs(); // Re-initialize search with fresh data
            });
        }
        function renderClientes() {
            const clientesListEl = document.getElementById('clientes-list');
            if (!clientesListEl) return;
            const searchTerm = document.getElementById('search-clientes').value.toLowerCase();
            
            const clientesConHistorial = allClientes.map(cliente => {
                const remisionesCliente = allRemisiones.filter(r => r.idCliente === cliente.id && r.estado !== 'Anulada');
                const totalComprado = remisionesCliente.reduce((sum, r) => sum + r.valorTotal, 0);
                let ultimaCompra = 'N/A';
                if (remisionesCliente.length > 0) {
                    remisionesCliente.sort((a, b) => new Date(b.fechaRecibido) - new Date(a.fechaRecibido));
                    ultimaCompra = remisionesCliente[0].fechaRecibido;
                }
                return { ...cliente, totalComprado, ultimaCompra };
            });

            const filtered = clientesConHistorial.filter(c => 
                c.nombre.toLowerCase().includes(searchTerm) || 
                c.email.toLowerCase().includes(searchTerm) || 
                c.telefono.includes(searchTerm)
            );

            clientesListEl.innerHTML = '';
            if (filtered.length === 0) { 
                clientesListEl.innerHTML = '<p class="text-center text-gray-500 py-8">No se encontraron clientes.</p>'; 
                return; 
            }
            
            filtered.forEach(cliente => {
                const clienteDiv = document.createElement('div');
                clienteDiv.className = 'border p-4 rounded-lg flex justify-between items-start';
                clienteDiv.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-lg">${cliente.nombre}</p>
                        <p class="text-sm text-gray-600">${cliente.email} | ${cliente.telefono}</p>
                        ${cliente.nit ? `<p class="text-sm text-gray-500">NIT: ${cliente.nit}</p>` : ''}
                        <div class="mt-2 pt-2 border-t border-gray-100 text-sm">
                            <p><span class="font-semibold">Última Compra:</span> ${cliente.ultimaCompra}</p>
                            <p><span class="font-semibold">Total Comprado:</span> ${formatCurrency(cliente.totalComprado)}</p>
                        </div>
                    </div>
                    <div class="flex-shrink-0 flex flex-col items-end gap-2">
                         <button data-client-json='${JSON.stringify(cliente)}' class="edit-client-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-sm font-semibold hover:bg-gray-300 w-full text-center">Editar</button>
                    </div>
                `;
                clientesListEl.appendChild(clienteDiv);
            });
            document.querySelectorAll('.edit-client-btn').forEach(btn => btn.addEventListener('click', (e) => showEditClientModal(JSON.parse(e.currentTarget.dataset.clientJson))));
        }
        function loadProveedores() {
            const q = query(collection(db, "proveedores"), orderBy("nombre", "asc"));
            onSnapshot(q, (snapshot) => {
                allProveedores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProveedores();
                setupSearchInputs(); // Re-initialize search with fresh data
            });
        }
        function renderProveedores() {
            const proveedoresListEl = document.getElementById('proveedores-list');
            if (!proveedoresListEl) return;
            const searchTerm = document.getElementById('search-proveedores').value.toLowerCase();
            const filtered = allProveedores.filter(p => p.nombre.toLowerCase().includes(searchTerm));

            proveedoresListEl.innerHTML = '';
            if (filtered.length === 0) { proveedoresListEl.innerHTML = '<p>No hay proveedores registrados.</p>'; return; }
            
            filtered.forEach(proveedor => {
                const el = document.createElement('div');
                el.className = 'border p-4 rounded-lg';
                el.innerHTML = `<p class="font-semibold">${proveedor.nombre}</p><p class="text-sm text-gray-600">${proveedor.email || ''} | ${proveedor.telefono || ''}</p>`;
                proveedoresListEl.appendChild(el);
            });
        }
        function loadRemisiones() {
            const q = query(collection(db, "remisiones"), orderBy("numeroRemision", "desc"));
            onSnapshot(q, (snapshot) => {
                allRemisiones = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRemisiones();
                renderFacturacion();
                renderClientes(); // Re-render clients to update their purchase history
            });
        }
        function renderRemisiones() {
            const remisionesListEl = document.getElementById('remisiones-list');
            if(!remisionesListEl) return;

            const isPlanta = currentUserData && currentUserData.role === 'planta';
            const month = document.getElementById('filter-remisiones-month').value;
            const year = document.getElementById('filter-remisiones-year').value;
            const searchTerm = document.getElementById('search-remisiones').value.toLowerCase();

            let filtered = allRemisiones;

            if (isPlanta) {
                const allowedStates = ['Recibido', 'En Proceso', 'Procesado'];
                filtered = filtered.filter(r => allowedStates.includes(r.estado));
            }

            if (year !== 'all') {
                filtered = filtered.filter(r => new Date(r.fechaRecibido).getFullYear() == year);
            }
            if (month !== 'all') {
                filtered = filtered.filter(r => new Date(r.fechaRecibido).getMonth() == month);
            }
            if (searchTerm) {
                filtered = filtered.filter(r => r.clienteNombre.toLowerCase().includes(searchTerm) || r.numeroRemision.toString().includes(searchTerm));
            }

            remisionesListEl.innerHTML = '';
            if (filtered.length === 0) { remisionesListEl.innerHTML = '<p class="text-center text-gray-500 py-8">No se encontraron remisiones.</p>'; return; }
            filtered.forEach((remision) => {
                const el = document.createElement('div');
                const esAnulada = remision.estado === 'Anulada';
                const esEntregada = remision.estado === 'Entregado';
                el.className = `border p-4 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 ${esAnulada ? 'remision-anulada' : ''}`;
                
                const totalPagado = (remision.payments || []).reduce((sum, p) => sum + p.amount, 0);
                const saldoPendiente = remision.valorTotal - totalPagado;
                
                let paymentStatusBadge = '';
                if (!esAnulada) {
                    if (saldoPendiente <= 0) {
                        paymentStatusBadge = `<span class="payment-status payment-pagado">Pagado</span>`;
                    } else {
                        if (isPlanta) {
                            paymentStatusBadge = `<span class="payment-status payment-pendiente">Pendiente</span>`;
                        } else {
                            if (totalPagado > 0) {
                                paymentStatusBadge = `<span class="payment-status payment-abono">Abono</span>`;
                            } else {
                                paymentStatusBadge = `<span class="payment-status payment-pendiente">Pendiente</span>`;
                            }
                        }
                    }
                }

                const pdfUrl = isPlanta ? remision.pdfPlantaUrl : remision.pdfUrl;
                const pdfButton = pdfUrl ? `<button data-pdf-url="${pdfUrl}" data-remision-num="${remision.numeroRemision}" class="view-pdf-btn w-full bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-700 transition text-center">Ver PDF</button>` : `<button class="w-full bg-gray-400 text-white px-4 py-2 rounded-lg text-sm font-semibold btn-disabled">Generando PDF...</button>`;
                const anularButton = esAnulada || esEntregada || isPlanta ? '' : `<button data-remision-id="${remision.id}" class="anular-btn w-full bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-yellow-600 transition">Anular</button>`;
                const pagosButton = esAnulada || isPlanta ? '' : `<button data-remision-json='${JSON.stringify(remision)}' class="payment-btn w-full bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-purple-700 transition">Pagos (${formatCurrency(saldoPendiente)})</button>`;

                const statusClasses = {'Recibido': 'status-recibido', 'En Proceso': 'status-en-proceso', 'Procesado': 'status-procesado', 'Entregado': 'status-entregado'};
                const statusBadge = `<span class="status-badge ${statusClasses[remision.estado] || ''}">${remision.estado}</span>`;

                let statusButton = '';
                const currentIndex = ESTADOS_REMISION.indexOf(remision.estado);
                if (!esAnulada && currentIndex < ESTADOS_REMISION.length - 1) {
                    const nextStatus = ESTADOS_REMISION[currentIndex + 1];
                    statusButton = `<button data-remision-id="${remision.id}" data-current-status="${remision.estado}" class="status-update-btn w-full bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-indigo-600 transition">Mover a ${nextStatus}</button>`;
                }

                el.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex items-center gap-3 flex-wrap">
                            <span class="remision-id">N° ${remision.numeroRemision}</span>
                            <p class="font-semibold text-lg">${remision.clienteNombre}</p>
                            ${statusBadge}
                            ${paymentStatusBadge}
                            ${esAnulada ? '<span class="px-2 py-1 bg-red-200 text-red-800 text-xs font-bold rounded-full">ANULADA</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-600 mt-1">Recibido: ${remision.fechaRecibido} &bull; ${remision.fechaEntrega ? `Entregado: ${remision.fechaEntrega}` : 'Entrega: Pendiente'}</p>
                        ${!isPlanta ? `<p class="text-sm text-gray-600 mt-1">Total: <span class="font-bold">${formatCurrency(remision.valorTotal)}</span></p>` : ''}
                    </div>
                    <div class="grid grid-cols-2 gap-2 flex-shrink-0 w-full sm:max-w-xs">
                        ${statusButton}
                        ${pdfButton}
                        ${pagosButton}
                        ${anularButton}
                    </div>`;
                remisionesListEl.appendChild(el);
            });
            document.querySelectorAll('.anular-btn').forEach(button => button.addEventListener('click', (e) => { const remisionId = e.currentTarget.dataset.remisionId; if(confirm(`¿Estás seguro de que quieres ANULAR esta remisión? Se enviará un correo de notificación al cliente.`)) { handleAnularRemision(remisionId); } }));
            document.querySelectorAll('.status-update-btn').forEach(button => button.addEventListener('click', (e) => { const remisionId = e.currentTarget.dataset.remisionId; const currentStatus = e.currentTarget.dataset.currentStatus; handleStatusUpdate(remisionId, currentStatus); }));
            document.querySelectorAll('.view-pdf-btn').forEach(button => button.addEventListener('click', (e) => { const pdfUrl = e.currentTarget.dataset.pdfUrl; const remisionNum = e.currentTarget.dataset.remisionNum; showPdfModal(pdfUrl, remisionNum); }));
            document.querySelectorAll('.payment-btn').forEach(button => button.addEventListener('click', (e) => { const remision = JSON.parse(e.currentTarget.dataset.remisionJson); showPaymentModal(remision); }));
        }
        function loadGastos() {
            const q = query(collection(db, "gastos"), orderBy("fecha", "desc"));
            onSnapshot(q, (snapshot) => {
                allGastos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGastos();
            });
        }
        function renderGastos() {
            const gastosListEl = document.getElementById('gastos-list');
            if(!gastosListEl) return;

            const month = document.getElementById('filter-gastos-month').value;
            const year = document.getElementById('filter-gastos-year').value;
            const searchTerm = document.getElementById('search-gastos').value.toLowerCase();
            
            let filtered = allGastos;

            if (year !== 'all') {
                filtered = filtered.filter(g => new Date(g.fecha).getFullYear() == year);
            }
            if (month !== 'all') {
                filtered = filtered.filter(g => new Date(g.fecha).getMonth() == month);
            }
            if (searchTerm) {
                filtered = filtered.filter(g => g.proveedorNombre.toLowerCase().includes(searchTerm) || (g.numeroFactura && g.numeroFactura.toLowerCase().includes(searchTerm)));
            }

            gastosListEl.innerHTML = '';
            if (filtered.length === 0) { gastosListEl.innerHTML = '<p class="text-center text-gray-500 py-8">No hay gastos registrados.</p>'; return; }
            filtered.forEach((gasto) => {
                const el = document.createElement('div');
                el.className = 'border p-4 rounded-lg flex justify-between items-center';
                el.innerHTML = `
                    <div>
                        <p class="font-semibold">${gasto.proveedorNombre}</p>
                        <p class="text-sm text-gray-600">${gasto.fecha} ${gasto.numeroFactura ? `| Factura: ${gasto.numeroFactura}` : ''}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg text-red-600">${formatCurrency(gasto.valorTotal)}</p>
                        <p class="text-sm text-gray-500">Pagado con: ${gasto.fuentePago}</p>
                    </div>
                `;
                gastosListEl.appendChild(el);
            });
        }
        function renderFacturacion() {
            const pendientesListEl = document.getElementById('facturacion-pendientes-list');
            const realizadasListEl = document.getElementById('facturacion-realizadas-list');
            if (!pendientesListEl || !realizadasListEl) return;

            const remisionesParaFacturar = allRemisiones.filter(r => r.incluyeIVA && r.estado !== 'Anulada');
            
            const pendientes = remisionesParaFacturar.filter(r => !r.facturado);
            const realizadas = remisionesParaFacturar.filter(r => r.facturado);

            pendientesListEl.innerHTML = '';
            if (pendientes.length === 0) {
                pendientesListEl.innerHTML = '<p class="text-center text-gray-500 py-8">No hay remisiones pendientes de facturar.</p>';
            } else {
                pendientes.forEach(remision => {
                    const el = document.createElement('div');
                    el.className = 'border p-4 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4';
                    el.innerHTML = `
                        <div class="flex-grow">
                            <div class="flex items-center gap-3 flex-wrap">
                                <span class="remision-id">N° ${remision.numeroRemision}</span>
                                <p class="font-semibold text-lg">${remision.clienteNombre}</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Fecha: ${remision.fechaRecibido} &bull; Total: <span class="font-bold">${formatCurrency(remision.valorTotal)}</span></p>
                        </div>
                        <div class="flex-shrink-0 flex items-center gap-2">
                            <button data-pdf-url="${remision.pdfUrl}" data-remision-num="${remision.numeroRemision}" class="view-pdf-btn bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-600">Ver Remisión</button>
                            <button data-remision-id="${remision.id}" class="facturar-btn bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-blue-700">Facturar</button>
                        </div>
                    `;
                    pendientesListEl.appendChild(el);
                });
            }

            realizadasListEl.innerHTML = '';
            if (realizadas.length === 0) {
                realizadasListEl.innerHTML = '<p class="text-center text-gray-500 py-8">No hay remisiones facturadas.</p>';
            } else {
                realizadas.forEach(remision => {
                    const el = document.createElement('div');
                    el.className = 'border p-4 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4';
                    el.innerHTML = `
                        <div class="flex-grow">
                            <div class="flex items-center gap-3 flex-wrap">
                                <span class="remision-id">N° ${remision.numeroRemision}</span>
                                <p class="font-semibold text-lg">${remision.clienteNombre}</p>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">Fecha: ${remision.fechaRecibido} &bull; Total: <span class="font-bold">${formatCurrency(remision.valorTotal)}</span></p>
                        </div>
                        <div class="flex-shrink-0 flex items-center gap-2">
                             <div class="text-right">
                                <span class="status-badge status-entregado">Facturado</span>
                                <p class="text-sm text-gray-600 mt-1">Factura N°: <span class="font-semibold">${remision.numeroFactura}</span></p>
                            </div>
                            <button data-pdf-url="${remision.pdfUrl}" data-remision-num="${remision.numeroRemision}" class="view-pdf-btn bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-600">Ver Remisión</button>
                        </div>
                    `;
                    realizadasListEl.appendChild(el);
                });
            }

            document.querySelectorAll('.facturar-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const remisionId = e.currentTarget.dataset.remisionId;
                    showFacturaModal(remisionId);
                });
            });
            document.querySelectorAll('.view-pdf-btn').forEach(button => button.addEventListener('click', (e) => { const pdfUrl = e.currentTarget.dataset.pdfUrl; const remisionNum = e.currentTarget.dataset.remisionNum; showPdfModal(pdfUrl, remisionNum); }));
        }
        
        // --- FUNCIONES DE MANEJO DE ACCIONES ---
        async function handleProveedorSubmit(e) { e.preventDefault(); const nuevoProveedor = { nombre: document.getElementById('nuevo-proveedor-nombre').value, contacto: document.getElementById('nuevo-proveedor-contacto').value, telefono: document.getElementById('nuevo-proveedor-telefono').value, email: document.getElementById('nuevo-proveedor-email').value, creadoEn: new Date(), }; showModalMessage("Registrando proveedor...", true); try { await addDoc(collection(db, "proveedores"), nuevoProveedor); e.target.reset(); hideModal(); showModalMessage("¡Proveedor registrado!", false, 2000); } catch (error) { console.error("Error al registrar proveedor:", error); hideModal(); showModalMessage("Error al registrar el proveedor."); } }
        async function handleGastoSubmit(e) {
            e.preventDefault();
            const valorTotal = unformatCurrency(document.getElementById('gasto-valor-total').value);
            const ivaIncluido = document.getElementById('gasto-iva').checked;
            const valorBase = ivaIncluido ? valorTotal / 1.19 : valorTotal;
            const proveedorId = document.getElementById('proveedor-id-hidden').value;
            const proveedorNombre = document.getElementById('proveedor-search-input').value;
            
            if (!proveedorId) {
                showModalMessage("Por favor, selecciona un proveedor de la lista.");
                return;
            }

            const nuevoGasto = {
                fecha: document.getElementById('gasto-fecha').value,
                proveedorId: proveedorId,
                proveedorNombre: proveedorNombre,
                numeroFactura: document.getElementById('gasto-factura').value,
                valorBase: valorBase,
                ivaIncluido: ivaIncluido,
                valorTotal: valorTotal,
                fuentePago: document.getElementById('gasto-fuente').value,
                registradoPor: currentUser.uid,
                timestamp: new Date(),
            };
            showModalMessage("Registrando gasto...", true);
            try {
                await addDoc(collection(db, "gastos"), nuevoGasto);
                e.target.reset();
                hideModal();
                showModalMessage("¡Gasto registrado con éxito!", false, 2000);
            } catch (error) {
                console.error("Error al registrar gasto:", error);
                hideModal();
                showModalMessage("Error al registrar el gasto.");
            }
        }
        async function handleStatusUpdate(remisionId, currentStatus) { const currentIndex = ESTADOS_REMISION.indexOf(currentStatus); if (currentIndex < ESTADOS_REMISION.length - 1) { const nextStatus = ESTADOS_REMISION[currentIndex + 1]; const updateData = { estado: nextStatus }; if (nextStatus === 'Entregado') { updateData.fechaEntrega = new Date().toISOString().split('T')[0]; } showModalMessage("Actualizando estado...", true); try { await updateDoc(doc(db, "remisiones", remisionId), updateData); hideModal(); } catch (error) { console.error("Error al actualizar estado:", error); showModalMessage("Error al actualizar estado."); } } }
        async function handleAnularRemision(remisionId) { showModalMessage("Anulando remisión...", true); try { const remisionRef = doc(db, "remisiones", remisionId); await updateDoc(remisionRef, { estado: "Anulada" }); hideModal(); showModalMessage("¡Remisión anulada con éxito!", false, 2000); } catch (error) { console.error("Error al anular la remisión:", error); hideModal(); showModalMessage("Error al anular la remisión."); } }
        async function handleRemisionSubmit(e) {
            e.preventDefault();
            const clienteId = document.getElementById('cliente-id-hidden').value;
            const clienteNombre = document.getElementById('cliente-search-input').value;
            const cliente = allClientes.find(c => c.id === clienteId);

            const itemsContainer = document.getElementById('items-container');
            if (!currentUser || !clienteId || !cliente) {
                showModalMessage("Debes seleccionar un cliente válido de la lista.");
                return;
            }
            if (itemsContainer.children.length === 0) {
                showModalMessage("Debes añadir al menos un ítem.");
                return;
            }
            showModalMessage("Guardando remisión...", true);
            const counterRef = doc(db, "counters", "remisionCounter");
            try {
                const newRemisionNumber = await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    if (!counterDoc.exists()) {
                        transaction.set(counterRef, { currentNumber: 1 });
                        return 1;
                    }
                    const newNumber = counterDoc.data().currentNumber + 1;
                    transaction.update(counterRef, { currentNumber: newNumber });
                    return newNumber;
                });
                const { subtotalGeneral, valorIVA, total } = calcularTotales();
                const items = Array.from(itemsContainer.querySelectorAll('.item-row')).map(row => ({
                    itemId: row.querySelector('.item-id-hidden').value,
                    referencia: row.querySelector('.item-id-hidden').dataset.ref,
                    descripcion: row.querySelector('.item-id-hidden').dataset.desc,
                    color: row.querySelector('.color-name-hidden').value,
                    cantidad: parseFloat(row.querySelector('.item-cantidad').value) || 0,
                    valorUnitario: unformatCurrency(row.querySelector('.item-valor-unitario').value) || 0,
                }));
                const formaDePago = document.getElementById('forma-pago').value;
                const initialPayments = [];
                if (formaDePago !== 'Pendiente') {
                    initialPayments.push({ amount: total, date: document.getElementById('fecha-recibido').value, method: formaDePago, registeredAt: new Date() });
                }
                const nuevaRemision = {
                    numeroRemision: newRemisionNumber,
                    idCliente: clienteId,
                    clienteNombre: clienteNombre,
                    clienteEmail: cliente.email,
                    fechaRecibido: document.getElementById('fecha-recibido').value,
                    fechaEntrega: null,
                    formaPago: formaDePago,
                    incluyeIVA: document.getElementById('incluir-iva').checked,
                    items: items,
                    subtotal: subtotalGeneral,
                    valorIVA: valorIVA,
                    valorTotal: total,
                    creadoPor: currentUser.uid,
                    timestamp: new Date(),
                    pdfUrl: null,
                    emailStatus: 'pending',
                    estado: 'Recibido',
                    payments: initialPayments,
                    facturado: false,
                    numeroFactura: null
                };
                await addDoc(collection(db, "remisiones"), nuevaRemision);
                e.target.reset();
                document.getElementById('cliente-search-input').value = '';
                document.getElementById('cliente-id-hidden').value = '';
                itemsContainer.innerHTML = '';
                itemsContainer.appendChild(createItemElement());
                calcularTotales();
                hideModal();
                showModalMessage("¡Remisión guardada! Se está procesando el correo.", false, 3000);
                document.getElementById('fecha-recibido').value = new Date().toISOString().split('T')[0];
            } catch (error) {
                console.error("Error en la transacción o al crear la remisión: ", error);
                hideModal();
                showModalMessage("Error al generar el número de remisión.");
            }
        }

        // --- FUNCIONES DE AYUDA Y MODALES ---
        function initSearchableInput(searchInput, resultsContainer, getDataFn, displayFn, onSelect) {
            searchInput.addEventListener('input', () => {
                const data = getDataFn();
                const searchTerm = searchInput.value.toLowerCase();
                onSelect(null);
                if (!searchTerm) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.classList.add('hidden');
                    return;
                }
                const filteredData = data.filter(item => displayFn(item).toLowerCase().includes(searchTerm));
                renderResults(filteredData);
            });

            searchInput.addEventListener('focus', () => {
                if (searchInput.value) {
                    searchInput.dispatchEvent(new Event('input'));
                }
            });

            function renderResults(results) {
                resultsContainer.innerHTML = '';
                if (results.length === 0) {
                    resultsContainer.classList.add('hidden');
                    return;
                }
                results.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    div.textContent = displayFn(item);
                    div.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        searchInput.value = displayFn(item);
                        resultsContainer.classList.add('hidden');
                        if (onSelect) onSelect(item);
                    });
                    resultsContainer.appendChild(div);
                });
                resultsContainer.classList.remove('hidden');
            }
            
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
                    resultsContainer.classList.add('hidden');
                }
            });
        }

        function setupSearchInputs() {
            // Cliente en Remisiones
            initSearchableInput(
                document.getElementById('cliente-search-input'),
                document.getElementById('cliente-search-results'),
                () => allClientes,
                (cliente) => cliente.nombre,
                (selectedCliente) => {
                    const hiddenInput = document.getElementById('cliente-id-hidden');
                    hiddenInput.value = selectedCliente ? selectedCliente.id : '';
                }
            );

            // Proveedor en Gastos
            initSearchableInput(
                document.getElementById('proveedor-search-input'),
                document.getElementById('proveedor-search-results'),
                () => allProveedores,
                (proveedor) => proveedor.nombre,
                (selectedProveedor) => {
                    const hiddenInput = document.getElementById('proveedor-id-hidden');
                    hiddenInput.value = selectedProveedor ? selectedProveedor.id : '';
                }
            );
        }

        function createItemElement() {
            dynamicElementCounter++;
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row grid grid-cols-1 gap-2';
            itemRow.dataset.id = dynamicElementCounter;

            itemRow.innerHTML = `
                <div class="relative">
                    <input type="text" id="item-search-${dynamicElementCounter}" autocomplete="off" placeholder="Buscar ítem..." class="item-search-input w-full p-2 border border-gray-300 rounded-lg" required>
                    <input type="hidden" class="item-id-hidden" name="itemId">
                    <div id="item-results-${dynamicElementCounter}" class="search-results hidden"></div>
                </div>
                <div class="relative">
                    <input type="text" id="color-search-${dynamicElementCounter}" autocomplete="off" placeholder="Buscar color..." class="color-search-input w-full p-2 border border-gray-300 rounded-lg" required>
                    <input type="hidden" class="color-name-hidden" name="colorName">
                    <div id="color-results-${dynamicElementCounter}" class="search-results hidden"></div>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <input type="number" class="item-cantidad p-2 border border-gray-300 rounded-lg" placeholder="Cant." min="1" required>
                    <input type="text" inputmode="numeric" class="item-valor-unitario p-2 border border-gray-300 rounded-lg" placeholder="Vlr. Unit." required>
                    <button type="button" class="remove-item-btn bg-red-500 text-white font-bold rounded-lg hover:bg-red-600">Eliminar</button>
                </div>
            `;

            setTimeout(() => {
                const itemSearchInput = document.getElementById(`item-search-${dynamicElementCounter}`);
                const itemResultsContainer = document.getElementById(`item-results-${dynamicElementCounter}`);
                const itemIdHidden = itemRow.querySelector('.item-id-hidden');
                
                initSearchableInput(itemSearchInput, itemResultsContainer, () => allItems, (item) => `${item.referencia} - ${item.descripcion}`, (selectedItem) => {
                    itemIdHidden.value = selectedItem ? selectedItem.id : '';
                    itemIdHidden.dataset.ref = selectedItem ? selectedItem.referencia : '';
                    itemIdHidden.dataset.desc = selectedItem ? selectedItem.descripcion : '';
                });

                const colorSearchInput = document.getElementById(`color-search-${dynamicElementCounter}`);
                const colorResultsContainer = document.getElementById(`color-results-${dynamicElementCounter}`);
                const colorNameHidden = itemRow.querySelector('.color-name-hidden');

                initSearchableInput(colorSearchInput, colorResultsContainer, () => allColores, (color) => color.nombre, (selectedColor) => {
                    colorNameHidden.value = selectedColor ? selectedColor.nombre : '';
                });
            }, 0);

            itemRow.querySelector('.remove-item-btn').addEventListener('click', () => { itemRow.remove(); calcularTotales(); });
            itemRow.querySelectorAll('input.item-cantidad, input.item-valor-unitario').forEach(input => input.addEventListener('input', calcularTotales));
            
            return itemRow;
        }
        function calcularTotales() { const itemsContainer = document.getElementById('items-container'); const ivaCheckbox = document.getElementById('incluir-iva'); const subtotalEl = document.getElementById('subtotal'); const valorIvaEl = document.getElementById('valor-iva'); const valorTotalEl = document.getElementById('valor-total'); if(!itemsContainer || !ivaCheckbox || !subtotalEl || !valorIvaEl || !valorTotalEl) return {subtotalGeneral: 0, valorIVA: 0, total: 0}; let subtotalGeneral = 0; itemsContainer.querySelectorAll('.item-row').forEach(row => { const cantidad = parseFloat(row.querySelector('.item-cantidad').value) || 0; const valorUnitario = unformatCurrency(row.querySelector('.item-valor-unitario').value); subtotalGeneral += cantidad * valorUnitario; }); const incluyeIVA = ivaCheckbox.checked; const valorIVA = incluyeIVA ? subtotalGeneral * 0.19 : 0; const total = subtotalGeneral + valorIVA; subtotalEl.textContent = formatCurrency(subtotalGeneral); valorIvaEl.textContent = formatCurrency(valorIVA); valorTotalEl.textContent = formatCurrency(total); return { subtotalGeneral, valorIVA, total }; }
        function showEditClientModal(client) { const modalContentWrapper = document.getElementById('modal-content-wrapper'); modalContentWrapper.innerHTML = `<div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full mx-auto text-center"><h2 class="text-xl font-semibold mb-4">Editar Cliente</h2><form id="edit-client-form" class="space-y-4 text-left"><input type="hidden" id="edit-client-id" value="${client.id}"><div><label for="edit-client-name" class="block text-sm font-medium text-gray-700">Nombre</label><input type="text" id="edit-client-name" class="w-full p-2 border border-gray-300 rounded-lg mt-1" value="${client.nombre}" required></div><div><label for="edit-client-email" class="block text-sm font-medium text-gray-700">Correo</label><input type="email" id="edit-client-email" class="w-full p-2 border border-gray-300 rounded-lg mt-1" value="${client.email}" required></div><div><label for="edit-client-phone" class="block text-sm font-medium text-gray-700">Teléfono</label><input type="tel" id="edit-client-phone" class="w-full p-2 border border-gray-300 rounded-lg mt-1" value="${client.telefono}" required></div><div><label for="edit-client-nit" class="block text-sm font-medium text-gray-700">NIT</label><input type="text" id="edit-client-nit" class="w-full p-2 border border-gray-300 rounded-lg mt-1" value="${client.nit || ''}"></div><div class="flex gap-4 justify-end pt-4"><button type="button" id="cancel-edit-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold">Cancelar</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold">Guardar Cambios</button></div></form></div>`; document.getElementById('modal').classList.remove('hidden'); document.getElementById('cancel-edit-btn').addEventListener('click', hideModal); document.getElementById('edit-client-form').addEventListener('submit', async (e) => { e.preventDefault(); const clientId = document.getElementById('edit-client-id').value; const updatedData = { nombre: document.getElementById('edit-client-name').value, email: document.getElementById('edit-client-email').value, telefono: document.getElementById('edit-client-phone').value, nit: document.getElementById('edit-client-nit').value, }; showModalMessage("Actualizando cliente...", true); try { await updateDoc(doc(db, "clientes", clientId), updatedData); hideModal(); showModalMessage("¡Cliente actualizado!", false, 2000); } catch (error) { console.error("Error al actualizar cliente:", error); showModalMessage("Error al actualizar."); } }); }
        function showPdfModal(pdfUrl, remisionNum) { const modalContentWrapper = document.getElementById('modal-content-wrapper'); modalContentWrapper.innerHTML = `<div class="bg-white rounded-lg shadow-xl w-full max-w-6xl mx-auto flex flex-col" style="height: 80vh;"><div class="flex justify-between items-center p-4 border-b"><h2 class="text-xl font-semibold">Visor de Remisión N° ${remisionNum}</h2><button id="close-pdf-modal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div class="flex-grow p-2 bg-gray-200"><iframe id="pdf-iframe" src="${pdfUrl}" class="w-full h-full" frameborder="0"></iframe></div></div>`; document.getElementById('modal').classList.remove('hidden'); document.getElementById('close-pdf-modal').addEventListener('click', hideModal); }
        function showPaymentModal(remision) { const modalContentWrapper = document.getElementById('modal-content-wrapper'); const totalPagado = (remision.payments || []).reduce((sum, p) => sum + p.amount, 0); const saldoPendiente = remision.valorTotal - totalPagado; const paymentsHTML = (remision.payments || []).map(p => `<tr class="border-b"><td class="p-2">${p.date}</td><td class="p-2">${p.method}</td><td class="p-2 text-right">${formatCurrency(p.amount)}</td></tr>`).join(''); modalContentWrapper.innerHTML = `<div class="bg-white rounded-lg p-6 shadow-xl max-w-2xl w-full mx-auto text-left"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Gestionar Pagos (Remisión N° ${remision.numeroRemision})</h2><button id="close-payment-modal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div class="grid grid-cols-3 gap-4 mb-4 text-center"><div class="bg-blue-50 p-3 rounded-lg"><div class="text-sm text-blue-800">VALOR TOTAL</div><div class="font-bold text-lg">${formatCurrency(remision.valorTotal)}</div></div><div class="bg-green-50 p-3 rounded-lg"><div class="text-sm text-green-800">TOTAL PAGADO</div><div class="font-bold text-lg">${formatCurrency(totalPagado)}</div></div><div class="bg-red-50 p-3 rounded-lg"><div class="text-sm text-red-800">SALDO PENDIENTE</div><div class="font-bold text-lg">${formatCurrency(saldoPendiente)}</div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 class="font-semibold mb-2">Historial de Pagos</h3><div class="border rounded-lg max-h-60 overflow-y-auto"><table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="p-2 text-left">Fecha</th><th class="p-2 text-left">Método</th><th class="p-2 text-right">Monto</th></tr></thead><tbody>${paymentsHTML || '<tr><td colspan="3" class="p-4 text-center text-gray-500">No hay pagos registrados.</td></tr>'}</tbody></table></div></div><div><h3 class="font-semibold mb-2">Registrar Nuevo Pago</h3>${saldoPendiente > 0 ? `<form id="add-payment-form" class="space-y-3 bg-gray-50 p-4 rounded-lg"><div><label for="new-payment-amount" class="text-sm font-medium">Monto del Abono</label><input type="text" inputmode="numeric" id="new-payment-amount" class="w-full p-2 border rounded-md mt-1" max="${saldoPendiente}" required></div><div><label for="new-payment-date" class="text-sm font-medium">Fecha del Pago</label><input type="date" id="new-payment-date" class="w-full p-2 border rounded-md mt-1" value="${new Date().toISOString().split('T')[0]}" required></div><div><label for="new-payment-method" class="text-sm font-medium">Método de Pago</label><select id="new-payment-method" class="w-full p-2 border rounded-md mt-1 bg-white" required><option value="Efectivo">Efectivo</option><option value="Nequi">Nequi</option><option value="Davivienda">Davivienda</option></select></div><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Registrar Pago</button></form>` : '<div class="bg-green-100 text-green-800 p-4 rounded-lg text-center font-semibold">Esta remisión ya ha sido pagada en su totalidad.</div>'}</div></div></div>`; document.getElementById('modal').classList.remove('hidden'); document.getElementById('close-payment-modal').addEventListener('click', hideModal); if (saldoPendiente > 0) { const paymentAmountInput = document.getElementById('new-payment-amount'); paymentAmountInput.addEventListener('focus', (e) => unformatCurrencyInput(e.target)); paymentAmountInput.addEventListener('blur', (e) => formatCurrencyInput(e.target)); document.getElementById('add-payment-form').addEventListener('submit', async (e) => { e.preventDefault(); const amount = unformatCurrency(paymentAmountInput.value); if (amount <= 0 || !amount) { alert("El monto debe ser mayor a cero."); return; } if (amount > saldoPendiente + 0.01) { alert("El monto del pago no puede superar el saldo pendiente."); return; } const newPayment = { amount: amount, date: document.getElementById('new-payment-date').value, method: document.getElementById('new-payment-method').value, registeredAt: new Date() }; showModalMessage("Registrando pago...", true); try { await updateDoc(doc(db, "remisiones", remision.id), { payments: arrayUnion(newPayment) }); hideModal(); showModalMessage("¡Pago registrado!", false, 2000); } catch (error) { console.error("Error al registrar pago:", error); showModalMessage("Error al registrar el pago."); } }); } }
        function showDashboardModal() {
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            
            modalContentWrapper.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl mx-auto text-left flex flex-col" style="height: 80vh;">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h2 class="text-xl font-semibold">Resumen Financiero</h2>
                        <div class="flex items-center gap-4">
                            <button id="download-report-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Descargar Reporte PDF</button>
                            <button id="close-dashboard-modal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                        </div>
                    </div>
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6 px-6">
                            <button id="dashboard-tab-summary" class="dashboard-tab-btn active py-4 px-1 font-semibold">Resumen Mensual</button>
                            <button id="dashboard-tab-cartera" class="dashboard-tab-btn py-4 px-1 font-semibold">Cartera</button>
                            <button id="dashboard-tab-clientes" class="dashboard-tab-btn py-4 px-1 font-semibold">Clientes</button>
                        </nav>
                    </div>
                    <div id="dashboard-summary-view" class="p-6 space-y-6 overflow-y-auto flex-grow"> <div class="flex items-center gap-4"><select id="summary-month" class="p-2 border rounded-lg"></select><select id="summary-year" class="p-2 border rounded-lg"></select></div><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"><div class="bg-green-100 p-4 rounded-lg"><div class="text-sm font-semibold text-green-800">VENTAS</div><div id="summary-sales" class="text-2xl font-bold"></div></div><div class="bg-red-100 p-4 rounded-lg"><div class="text-sm font-semibold text-red-800">GASTOS</div><div id="summary-expenses" class="text-2xl font-bold"></div></div><div class="bg-indigo-100 p-4 rounded-lg"><div class="text-sm font-semibold text-indigo-800">UTILIDAD/PÉRDIDA</div><div id="summary-profit" class="text-2xl font-bold"></div></div><div class="bg-yellow-100 p-4 rounded-lg"><div class="text-sm font-semibold text-yellow-800">CARTERA PENDIENTE (MES)</div><div id="summary-cartera" class="text-2xl font-bold"></div></div></div><div><h3 class="font-semibold mb-2">Saldos Estimados (Total)</h3><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"><div class="bg-gray-100 p-4 rounded-lg"><div class="text-sm font-semibold text-gray-800">EFECTIVO</div><div id="summary-efectivo" class="text-xl font-bold"></div></div><div class="bg-gray-100 p-4 rounded-lg"><div class="text-sm font-semibold text-gray-800">NEQUI</div><div id="summary-nequi" class="text-xl font-bold"></div></div><div class="bg-gray-100 p-4 rounded-lg"><div class="text-sm font-semibold text-gray-800">DAVIVIENDA</div><div id="summary-davivienda" class="text-xl font-bold"></div></div><div class="bg-gray-100 p-4 rounded-lg"><div class="text-sm font-semibold text-gray-800">CARTERA TOTAL</div><div id="summary-cartera-total" class="text-xl font-bold"></div></div></div></div><div><h3 class="font-semibold mb-2">Utilidad/Pérdida (Últimos 6 Meses)</h3><div class="bg-gray-50 p-4 rounded-lg"><canvas id="profitLossChart"></canvas></div></div></div>
                    <div id="dashboard-cartera-view" class="p-6 hidden flex-grow overflow-y-auto"><h3 class="font-semibold mb-2 text-xl">Cartera Pendiente de Cobro</h3><div id="cartera-list" class="space-y-4"></div><div id="cartera-total" class="text-right font-bold text-xl mt-4"></div></div>
                    <div id="dashboard-clientes-view" class="p-6 hidden flex-grow overflow-y-auto">
                        <h3 class="font-semibold mb-2 text-xl">Ranking de Clientes</h3>
                        <div class="flex flex-wrap items-center gap-4 mb-4 p-2 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium">Desde:</label>
                                <select id="rank-start-month" class="p-2 border rounded-lg"></select>
                                <select id="rank-start-year" class="p-2 border rounded-lg"></select>
                            </div>
                            <div class="flex items-center gap-2">
                                <label class="text-sm font-medium">Hasta:</label>
                                <select id="rank-end-month" class="p-2 border rounded-lg"></select>
                                <select id="rank-end-year" class="p-2 border rounded-lg"></select>
                            </div>
                            <button id="rank-filter-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Filtrar</button>
                            <button id="rank-show-all-btn" class="bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-700">Mostrar Todos</button>
                        </div>
                        <div id="top-clientes-list" class="space-y-3"></div>
                    </div>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('close-dashboard-modal').addEventListener('click', hideModal);

            const monthSelect = document.getElementById('summary-month');
            const yearSelect = document.getElementById('summary-year');
            const rankStartMonth = document.getElementById('rank-start-month');
            const rankStartYear = document.getElementById('rank-start-year');
            const rankEndMonth = document.getElementById('rank-end-month');
            const rankEndYear = document.getElementById('rank-end-year');

            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const now = new Date();
            
            [monthSelect, rankStartMonth, rankEndMonth].forEach(sel => {
                for (let i = 0; i < 12; i++) { const option = document.createElement('option'); option.value = i; option.textContent = monthNames[i]; if (i === now.getMonth()) option.selected = true; sel.appendChild(option); }
            });
            [yearSelect, rankStartYear, rankEndYear].forEach(sel => {
                for (let i = 0; i < 5; i++) { const year = now.getFullYear() - i; const option = document.createElement('option'); option.value = year; option.textContent = year; sel.appendChild(option); }
            });
            
            const updateDashboardView = () => updateDashboard(parseInt(yearSelect.value), parseInt(monthSelect.value));
            monthSelect.addEventListener('change', updateDashboardView);
            yearSelect.addEventListener('change', updateDashboardView);

            document.getElementById('rank-filter-btn').addEventListener('click', () => {
                const startDate = new Date(rankStartYear.value, rankStartMonth.value, 1);
                const endDate = new Date(rankEndYear.value, parseInt(rankEndMonth.value) + 1, 0);
                renderTopClientes(startDate, endDate);
            });
            document.getElementById('rank-show-all-btn').addEventListener('click', () => renderTopClientes());


            const summaryTab = document.getElementById('dashboard-tab-summary');
            const carteraTab = document.getElementById('dashboard-tab-cartera');
            const clientesTab = document.getElementById('dashboard-tab-clientes');
            const summaryView = document.getElementById('dashboard-summary-view');
            const carteraView = document.getElementById('dashboard-cartera-view');
            const clientesView = document.getElementById('dashboard-clientes-view');

            summaryTab.addEventListener('click', () => { 
                summaryTab.classList.add('active'); 
                carteraTab.classList.remove('active'); 
                clientesTab.classList.remove('active');
                summaryView.classList.remove('hidden'); 
                carteraView.classList.add('hidden');
                clientesView.classList.add('hidden');
            });
            carteraTab.addEventListener('click', () => { 
                carteraTab.classList.add('active'); 
                summaryTab.classList.remove('active'); 
                clientesTab.classList.remove('active');
                carteraView.classList.remove('hidden'); 
                summaryView.classList.add('hidden');
                clientesView.classList.add('hidden');
            });
             clientesTab.addEventListener('click', () => { 
                clientesTab.classList.add('active'); 
                summaryTab.classList.remove('active'); 
                carteraTab.classList.remove('active');
                clientesView.classList.remove('hidden'); 
                summaryView.classList.add('hidden');
                carteraView.classList.add('hidden');
            });

            document.getElementById('download-report-btn').addEventListener('click', showReportDateRangeModal);
            
            updateDashboardView();
            renderCartera();
            renderTopClientes();
        }
        function updateDashboard(year, month) { const salesThisMonth = allRemisiones.flatMap(r => r.payments || []).filter(p => { const d = new Date(p.date); return d.getMonth() === month && d.getFullYear() === year; }).reduce((sum, p) => sum + p.amount, 0); const expensesThisMonth = allGastos.filter(g => { const d = new Date(g.fecha); return d.getMonth() === month && d.getFullYear() === year; }).reduce((sum, g) => sum + g.valorTotal, 0); document.getElementById('summary-sales').textContent = formatCurrency(salesThisMonth); document.getElementById('summary-expenses').textContent = formatCurrency(expensesThisMonth); document.getElementById('summary-profit').textContent = formatCurrency(salesThisMonth - expensesThisMonth); const totalCartera = allRemisiones.filter(r => r.estado !== 'Anulada').reduce((sum, r) => { const totalPagado = (r.payments || []).reduce((s, p) => s + p.amount, 0); const saldo = r.valorTotal - totalPagado; return sum + (saldo > 0 ? saldo : 0); }, 0); document.getElementById('summary-cartera').textContent = formatCurrency(totalCartera); document.getElementById('summary-cartera-total').textContent = formatCurrency(totalCartera); const accountBalances = { Efectivo: 0, Nequi: 0, Davivienda: 0 }; allRemisiones.forEach(r => (r.payments || []).forEach(p => { if(accountBalances[p.method] !== undefined) accountBalances[p.method] += p.amount; })); allGastos.forEach(g => { if(accountBalances[g.fuentePago] !== undefined) accountBalances[g.fuentePago] -= g.valorTotal; }); document.getElementById('summary-efectivo').textContent = formatCurrency(accountBalances.Efectivo); document.getElementById('summary-nequi').textContent = formatCurrency(accountBalances.Nequi); document.getElementById('summary-davivienda').textContent = formatCurrency(accountBalances.Davivienda); const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"]; const labels = []; const salesData = []; const expensesData = []; for (let i = 5; i >= 0; i--) { const d = new Date(); d.setMonth(d.getMonth() - i); const m = d.getMonth(); const y = d.getFullYear(); labels.push(monthNames[m]); const monthlySales = allRemisiones.flatMap(r => r.payments || []).filter(p => { const pDate = new Date(p.date); return pDate.getMonth() === m && pDate.getFullYear() === y; }).reduce((sum, p) => sum + p.amount, 0); const monthlyExpenses = allGastos.filter(g => { const gDate = new Date(g.fecha); return gDate.getMonth() === m && gDate.getFullYear() === y; }).reduce((sum, g) => sum + g.valorTotal, 0); salesData.push(monthlySales); expensesData.push(monthlyExpenses); } const ctx = document.getElementById('profitLossChart').getContext('2d'); if (profitLossChart) { profitLossChart.destroy(); } profitLossChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Ventas', data: salesData, backgroundColor: 'rgba(75, 192, 192, 0.6)' }, { label: 'Gastos', data: expensesData, backgroundColor: 'rgba(255, 99, 132, 0.6)' }] }, options: { scales: { y: { beginAtZero: true } } } }); }
        
        function calculateOverdueDays(dateString) {
            const today = new Date();
            const receivedDate = new Date(dateString);
            today.setHours(0, 0, 0, 0);
            receivedDate.setHours(0, 0, 0, 0);
            const diffTime = today - receivedDate;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 0;
        }

        function renderCartera() {
            const carteraListEl = document.getElementById('cartera-list');
            const carteraTotalEl = document.getElementById('cartera-total');
            const pendingRemisiones = allRemisiones.filter(r => {
                if (r.estado === 'Anulada') return false;
                const totalPagado = (r.payments || []).reduce((sum, p) => sum + p.amount, 0);
                return r.valorTotal - totalPagado > 0.01;
            }).sort((a, b) => new Date(a.fechaRecibido) - new Date(b.fechaRecibido));

            carteraListEl.innerHTML = ''; // Clear previous content

            if (pendingRemisiones.length === 0) {
                carteraListEl.innerHTML = '<p class="text-center text-gray-500 py-8">¡No hay cartera pendiente!</p>';
                carteraTotalEl.innerHTML = '';
                return;
            }

            let totalCartera = 0;
            pendingRemisiones.forEach(r => {
                const totalPagado = (r.payments || []).reduce((sum, p) => sum + p.amount, 0);
                const saldoPendiente = r.valorTotal - totalPagado;
                totalCartera += saldoPendiente;
                const overdueDays = calculateOverdueDays(r.fechaRecibido);
                let overdueColor = 'text-gray-600';
                if (overdueDays > 30) overdueColor = 'text-yellow-600';
                if (overdueDays > 60) overdueColor = 'text-red-600';

                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200';
                card.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                        <div class="mb-2 sm:mb-0">
                            <p class="font-bold text-gray-800">${r.clienteNombre}</p>
                            <p class="text-sm text-gray-500">Remisión N° <span class="font-mono">${r.numeroRemision}</span> &bull; Recibido: ${r.fechaRecibido}</p>
                        </div>
                        <div class="text-left sm:text-right w-full sm:w-auto">
                             <p class="text-sm text-gray-500">Saldo Pendiente</p>
                            <p class="font-bold text-xl text-red-600">${formatCurrency(saldoPendiente)}</p>
                        </div>
                    </div>
                    <div class="mt-2 pt-2 border-t border-gray-200 text-sm flex justify-between items-center">
                        <p><span class="font-semibold">Valor Total:</span> ${formatCurrency(r.valorTotal)}</p>
                        <p class="${overdueColor} font-semibold">${overdueDays} días de vencido</p>
                    </div>
                `;
                carteraListEl.appendChild(card);
            });

            carteraTotalEl.innerHTML = `Total Cartera: <span class="text-red-600">${formatCurrency(totalCartera)}</span>`;
        }
        function renderTopClientes(startDate, endDate) {
            const container = document.getElementById('top-clientes-list');
            if (!container) return;

            let remisionesToAnalyze = allRemisiones;
            if (startDate && endDate) {
                remisionesToAnalyze = allRemisiones.filter(r => {
                    const d = new Date(r.fechaRecibido);
                    return d >= startDate && d <= endDate;
                });
            }

            const clientesConHistorial = allClientes.map(cliente => {
                const remisionesCliente = remisionesToAnalyze.filter(r => r.idCliente === cliente.id && r.estado !== 'Anulada');
                const totalComprado = remisionesCliente.reduce((sum, r) => sum + r.valorTotal, 0);
                return { ...cliente, totalComprado, numCompras: remisionesCliente.length };
            }).filter(c => c.numCompras > 0)
              .sort((a, b) => b.totalComprado - a.totalComprado);
            
            container.innerHTML = '';
            if (clientesConHistorial.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-8">No hay datos de compras de clientes para el rango seleccionado.</p>';
                return;
            }

            clientesConHistorial.forEach(cliente => {
                const el = document.createElement('div');
                el.className = 'border p-4 rounded-lg';
                el.innerHTML = `
                    <div class="flex justify-between items-center">
                        <p class="font-semibold text-lg">${cliente.nombre}</p>
                        <p class="font-bold text-xl text-green-600">${formatCurrency(cliente.totalComprado)}</p>
                    </div>
                    <p class="text-sm text-gray-600">${cliente.numCompras} ${cliente.numCompras === 1 ? 'compra' : 'compras'}</p>
                `;
                container.appendChild(el);
            });
        }
        const modal = document.getElementById('modal');
        let modalTimeout;
        function showModalMessage(message, isLoader = false, duration = 0) {
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            modalContentWrapper.innerHTML = `<div id="modal-content" class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full mx-auto text-center"></div>`;
            const modalContent = document.getElementById('modal-content');
            clearTimeout(modalTimeout);

            let contentHTML = '';
            if (isLoader) {
                contentHTML = `<svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-4 text-gray-700 font-semibold">${message}</p>`;
            } else {
                contentHTML = `<p class="text-gray-800 font-semibold mb-4">${message}</p>`;
                if (duration === 0) {
                    contentHTML += `<button id="close-message-modal-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Cerrar</button>`;
                }
            }
            
            modalContent.innerHTML = contentHTML;
            modal.classList.remove('hidden');

            if (duration > 0) {
                modalTimeout = setTimeout(hideModal, duration);
            } else if (!isLoader) {
                const closeBtn = document.getElementById('close-message-modal-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', hideModal);
                }
            }
        }
        function hideModal() { modal.classList.add('hidden'); }
        function formatCurrency(value) { return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value); }
        function populateDateFilters(prefix) {
            const monthSelect = document.getElementById(`${prefix}-month`);
            const yearSelect = document.getElementById(`${prefix}-year`);
            if (!monthSelect || !yearSelect) return;

            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            monthSelect.innerHTML = '<option value="all">Todos los Meses</option>';
            for (let i = 0; i < 12; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = monthNames[i];
                monthSelect.appendChild(option);
            }

            yearSelect.innerHTML = '<option value="all">Todos los Años</option>';
            const currentYear = new Date().getFullYear();
            for (let i = 0; i < 5; i++) {
                const year = currentYear - i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }
        function unformatCurrency(value) {
            if (typeof value !== 'string') return parseFloat(value) || 0;
            return parseFloat(value.replace(/[^0-9]/g, '')) || 0;
        }
        function formatCurrencyInput(inputElement) {
            const value = unformatCurrency(inputElement.value);
            inputElement.value = value > 0 ? formatCurrency(value) : '';
        }
        function unformatCurrencyInput(inputElement) {
            const value = unformatCurrency(inputElement.value);
            inputElement.value = value > 0 ? value : '';
        }
        function showReportDateRangeModal() {
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            const now = new Date();
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            let monthOptions = '';
            for (let i = 0; i < 12; i++) {
                monthOptions += `<option value="${i}" ${i === now.getMonth() ? 'selected' : ''}>${monthNames[i]}</option>`;
            }

            let yearOptions = '';
            for (let i = 0; i < 5; i++) {
                const year = now.getFullYear() - i;
                yearOptions += `<option value="${year}">${year}</option>`;
            }

            modalContentWrapper.innerHTML = `
                <div class="bg-white rounded-lg p-6 shadow-xl max-w-lg w-full mx-auto text-left">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Seleccionar Rango del Reporte</h2>
                        <button id="close-report-range-modal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                    </div>
                    <form id="report-range-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium">Mes de Inicio</label>
                                <select id="report-start-month" class="w-full p-2 border rounded-lg">${monthOptions}</select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Año de Inicio</label>
                                <select id="report-start-year" class="w-full p-2 border rounded-lg">${yearOptions}</select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium">Mes de Fin</label>
                                <select id="report-end-month" class="w-full p-2 border rounded-lg">${monthOptions}</select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Año de Fin</label>
                                <select id="report-end-year" class="w-full p-2 border rounded-lg">${yearOptions}</select>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Generar Reporte</button>
                    </form>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('close-report-range-modal').addEventListener('click', hideModal);
            document.getElementById('report-range-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const startMonth = parseInt(document.getElementById('report-start-month').value);
                const startYear = parseInt(document.getElementById('report-start-year').value);
                const endMonth = parseInt(document.getElementById('report-end-month').value);
                const endYear = parseInt(document.getElementById('report-end-year').value);
                
                generateSummaryPDF(startYear, startMonth, endYear, endMonth);
                hideModal();
            });
        }
        function generateSummaryPDF(startYear, startMonth, endYear, endMonth) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const startDate = new Date(startYear, startMonth, 1);
            const endDate = new Date(endYear, endMonth + 1, 0);

            const rangeTitle = `${monthNames[startMonth]} ${startYear} - ${monthNames[endMonth]} ${endYear}`;
            doc.setFontSize(20);
            doc.text(`Reporte Financiero: ${rangeTitle}`, 105, 20, { align: "center" });

            // Calculate totals for the entire period
            const salesInRange = allRemisiones.flatMap(r => r.payments || []).filter(p => { const d = new Date(p.date); return d >= startDate && d <= endDate; }).reduce((sum, p) => sum + p.amount, 0);
            const expensesInRange = allGastos.filter(g => { const d = new Date(g.fecha); return d >= startDate && d <= endDate; }).reduce((sum, g) => sum + g.valorTotal, 0);
            const profitInRange = salesInRange - expensesInRange;

            const summaryData = [
                ['Ventas Totales en el Período', formatCurrency(salesInRange)],
                ['Gastos Totales en el Período', formatCurrency(expensesInRange)],
                ['Utilidad/Pérdida Total', formatCurrency(profitInRange)],
            ];
            
            doc.autoTable({
                startY: 30,
                head: [['Resumen del Período', 'Valor']],
                body: summaryData,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185] }
            });

            // Monthly breakdown
            const monthlyData = [];
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const monthName = monthNames[month];

                const monthlySales = allRemisiones.flatMap(r => r.payments || []).filter(p => { const d = new Date(p.date); return d.getMonth() === month && d.getFullYear() === year; }).reduce((sum, p) => sum + p.amount, 0);
                const monthlyExpenses = allGastos.filter(g => { const d = new Date(g.fecha); return d.getMonth() === month && d.getFullYear() === year; }).reduce((sum, g) => sum + g.valorTotal, 0);
                const monthlyProfit = monthlySales - monthlyExpenses;
                const endOfMonth = new Date(year, month + 1, 0);
                const carteraAtEndOfMonth = allRemisiones.filter(r => new Date(r.fechaRecibido) <= endOfMonth && r.estado !== 'Anulada').reduce((sum, r) => { const totalPagado = (r.payments || []).filter(p => new Date(p.date) <= endOfMonth).reduce((s, p) => s + p.amount, 0); const saldo = r.valorTotal - totalPagado; return sum + (saldo > 0 ? saldo : 0); }, 0);


                monthlyData.push([
                    `${monthName} ${year}`,
                    formatCurrency(monthlySales),
                    formatCurrency(monthlyExpenses),
                    formatCurrency(monthlyProfit),
                    formatCurrency(carteraAtEndOfMonth)
                ]);
                currentDate.setMonth(currentDate.getMonth() + 1);
            }

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10,
                head: [['Mes', 'Ventas', 'Gastos', 'Utilidad/Pérdida', 'Cartera al Cierre']],
                body: monthlyData,
                theme: 'striped',
                headStyles: { fillColor: [22, 160, 133] }
            });

            const accountBalances = { Efectivo: 0, Nequi: 0, Davivienda: 0 };
            allRemisiones.forEach(r => (r.payments || []).forEach(p => { if(accountBalances[p.method] !== undefined) accountBalances[p.method] += p.amount; }));
            allGastos.forEach(g => { if(accountBalances[g.fuentePago] !== undefined) accountBalances[g.fuentePago] -= g.valorTotal; });
            const totalCartera = allRemisiones.filter(r => r.estado !== 'Anulada').reduce((sum, r) => { const totalPagado = (r.payments || []).reduce((s, p) => s + p.amount, 0); const saldo = r.valorTotal - totalPagado; return sum + (saldo > 0 ? saldo : 0); }, 0);

            const accountData = [
                ['Efectivo', formatCurrency(accountBalances.Efectivo)],
                ['Nequi', formatCurrency(accountBalances.Nequi)],
                ['Davivienda', formatCurrency(accountBalances.Davivienda)],
                ['Cartera Total Pendiente', formatCurrency(totalCartera)],
            ];

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10,
                head: [['Saldos y Totales Actuales', 'Valor']],
                body: accountData,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185] }
            });

            doc.save(`Reporte-Financiero-${startYear}-${startMonth+1}_a_${endYear}-${endMonth+1}.pdf`);
        }
        function showPermissionsModal(user) {
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            const userPermissions = user.permissions || {};

            let permissionsHTML = ALL_MODULES.filter(m => m !== 'empleados').map(module => {
                const isChecked = userPermissions[module] || false;
                const capitalized = module.charAt(0).toUpperCase() + module.slice(1);
                return `
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="permission-checkbox h-4 w-4 rounded border-gray-300" data-module="${module}" ${isChecked ? 'checked' : ''}>
                        <span>${capitalized}</span>
                    </label>
                `;
            }).join('');

            modalContentWrapper.innerHTML = `
                <div class="bg-white rounded-lg p-6 shadow-xl max-w-lg w-full mx-auto text-left">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Gestionar Permisos para ${user.nombre}</h2>
                        <button id="close-permissions-modal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                    </div>
                    <form id="permissions-form" class="space-y-4">
                        <input type="hidden" id="permission-user-id" value="${user.id}">
                        <div>
                            <label class="block text-sm font-medium">Rol</label>
                            <select id="role-select" class="w-full p-2 border rounded-lg mt-1 bg-white">
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrador</option>
                                <option value="facturador" ${user.role === 'facturador' ? 'selected' : ''}>Facturador</option>
                                <option value="planta" ${user.role === 'planta' ? 'selected' : ''}>Planta</option>
                                <option value="employee" ${user.role === 'employee' ? 'selected' : ''}>Empleado</option>
                            </select>
                        </div>
                        <div id="permissions-container">
                            <label class="block text-sm font-medium mb-2">Permisos de Módulos</label>
                            <div class="grid grid-cols-2 gap-2">
                                ${permissionsHTML}
                            </div>
                        </div>
                        <div class="flex justify-end pt-4">
                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            `;

            const roleSelect = document.getElementById('role-select');
            const permissionsContainer = document.getElementById('permissions-container');
            const checkboxes = permissionsContainer.querySelectorAll('.permission-checkbox');

            function togglePermissionsUI(role) {
                if (role === 'admin') {
                    permissionsContainer.style.display = 'none';
                } else {
                    permissionsContainer.style.display = 'block';
                }
            }

            function setPermissionsForRole(role) {
                let newPermissions = {};
                if (role === 'facturador') {
                    newPermissions = { remisiones: true, facturacion: true, clientes: true, items: false, colores: false, gastos: true, proveedores: true };
                } else if (role === 'employee') {
                    newPermissions = { remisiones: true, facturacion: false, clientes: true, items: true, colores: true, gastos: false, proveedores: false };
                } else if (role === 'planta') {
                    newPermissions = { remisiones: true, facturacion: false, clientes: false, items: false, colores: false, gastos: false, proveedores: false };
                }
                
                checkboxes.forEach(cb => {
                    cb.checked = newPermissions[cb.dataset.module] || false;
                });
            }

            roleSelect.addEventListener('change', (e) => {
                const newRole = e.target.value;
                togglePermissionsUI(newRole);
                setPermissionsForRole(newRole);
            });

            togglePermissionsUI(user.role);

            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('close-permissions-modal').addEventListener('click', hideModal);
            document.getElementById('permissions-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const userId = document.getElementById('permission-user-id').value;
                const newRole = document.getElementById('role-select').value;
                const newPermissions = {};
                
                checkboxes.forEach(cb => {
                    newPermissions[cb.dataset.module] = cb.checked;
                });
                
                showModalMessage("Guardando cambios...", true);
                try {
                    await updateDoc(doc(db, "users", userId), {
                        role: newRole,
                        permissions: newPermissions
                    });
                    hideModal();
                    showModalMessage("Permisos actualizados.", false, 2000);
                } catch (error) {
                    console.error("Error al actualizar permisos:", error);
                    showModalMessage("Error al guardar los cambios.");
                }
            });
        }

        function showDocumentModal(empleado, title, docTypes, storagePrefix) {
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            const employeeDocs = empleado.documentos ? (empleado.documentos[storagePrefix] || {}) : {};

            let documentsHTML = docTypes.map(docType => {
                const docUrl = employeeDocs[docType.id];
                const fileInputId = `file-${storagePrefix}-${docType.id}-${empleado.id}`;
                return `
                    <div class="flex justify-between items-center p-3 border-b">
                        <span class="font-medium">${docType.name}</span>
                        <div class="flex items-center gap-2">
                            ${docUrl ? `<a href="${docUrl}" target="_blank" class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-600">Ver</a>` : '<span class="text-xs text-gray-400">No adjunto</span>'}
                            <input type="file" id="${fileInputId}" class="hidden" accept=".pdf,.jpg,.jpeg,.png">
                            <label for="${fileInputId}" class="bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-sm font-semibold cursor-pointer hover:bg-gray-300">Adjuntar</label>
                        </div>
                    </div>
                `;
            }).join('');

            modalContentWrapper.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-auto text-left flex flex-col" style="max-height: 80vh;">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h2 class="text-xl font-semibold">${title}: ${empleado.nombre}</h2>
                        <div class="flex items-center gap-2">
                           <button id="download-all-docs-btn" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-semibold hover:bg-blue-700">Descargar todo (.zip)</button>
                           <button id="close-docs-modal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                        </div>
                    </div>
                    <div class="p-4 overflow-y-auto">
                        ${documentsHTML}
                    </div>
                </div>
            `;

            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('close-docs-modal').addEventListener('click', hideModal);
            document.getElementById('download-all-docs-btn').addEventListener('click', () => handleDownloadAllDocs(empleado, storagePrefix));


            docTypes.forEach(docType => {
                const fileInputId = `file-${storagePrefix}-${docType.id}-${empleado.id}`;
                const fileInput = document.getElementById(fileInputId);
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        handleFileUpload(empleado.id, `documentos.${storagePrefix}.${docType.id}`, file);
                    }
                });
            });
        }

        async function handleFileUpload(employeeId, docPath, file) {
            if (!file) return;
            showModalMessage("Subiendo documento...", true);

            const storagePath = `empleados/${employeeId}/${docPath.replace(/\./g, '/')}/${file.name}`;
            const storageRef = ref(storage, storagePath);
            
            try {
                const snapshot = await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(snapshot.ref);
                
                const updateData = {};
                updateData[docPath] = downloadURL;

                await updateDoc(doc(db, "users", employeeId), updateData);

                hideModal();
                showModalMessage("¡Documento subido y guardado!", false, 2000);
            } catch (error) {
                console.error("Error al subir archivo:", error);
                hideModal();
                showModalMessage("Error al subir el documento.");
            }
        }
        
        async function handleDownloadAllDocs(empleado, storagePrefix) {
            const employeeDocs = empleado.documentos ? (empleado.documentos[storagePrefix] || {}) : {};
            const docUrls = Object.entries(employeeDocs);

            if (docUrls.length === 0) {
                showModalMessage("No hay documentos para descargar.", false, 3000);
                return;
            }

            showModalMessage("Generando archivo .zip...", true);

            try {
                const zip = new JSZip();
                
                const promises = docUrls.map(async ([docType, url]) => {
                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`Error fetching ${docType}: ${response.statusText}`);
                        }
                        const blob = await response.blob();
                        
                        const urlPath = new URL(url).pathname;
                        const fileNameWithToken = urlPath.split('/').pop();
                        const decodedFileName = decodeURIComponent(fileNameWithToken.split('?')[0]);
                        const originalFileName = decodedFileName.split('/').pop(); 
                        
                        zip.file(originalFileName, blob);
                    } catch (error) {
                        console.error(`Could not download file for ${docType}:`, error);
                    }
                });

                await Promise.all(promises);

                const zipBlob = await zip.generateAsync({ type: "blob" });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipBlob);
                link.download = `${empleado.nombre.replace(/\s+/g, '_')}_documentos_${storagePrefix}.zip`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

                hideModal();

            } catch (error) {
                console.error("Error creating zip file:", error);
                hideModal();
                showModalMessage("Error al crear el archivo .zip.", false, 3000);
            }
        }

        function showFacturaModal(remisionId) {
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            modalContentWrapper.innerHTML = `
                <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full mx-auto text-left">
                    <h2 class="text-xl font-semibold mb-4">Registrar Factura</h2>
                    <form id="factura-form">
                        <label for="numero-factura" class="block text-sm font-medium text-gray-700">Número de Factura</label>
                        <input type="text" id="numero-factura" class="w-full p-2 border border-gray-300 rounded-lg mt-1" required>
                        <div class="flex gap-4 justify-end pt-4 mt-4">
                            <button type="button" id="cancel-factura-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold">Cancelar</button>
                            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold">Guardar</button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('cancel-factura-btn').addEventListener('click', hideModal);
            document.getElementById('factura-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const numeroFactura = document.getElementById('numero-factura').value;
                if (!numeroFactura) {
                    alert('Por favor, ingresa un número de factura.');
                    return;
                }
                showModalMessage("Guardando...", true);
                try {
                    await updateDoc(doc(db, "remisiones", remisionId), {
                        facturado: true,
                        numeroFactura: numeroFactura
                    });
                    hideModal();
                    showModalMessage("¡Remisión marcada como facturada!", false, 2000);
                } catch (error) {
                    console.error("Error al actualizar la remisión:", error);
                    showModalMessage("Error al guardar la factura.");
                }
            });
        }

        function showObrasDocsModal(empleado) {
            showDocumentModal(empleado, 'Documentos de Ingreso a Obras', OBRAS_DOCUMENT_TYPES, 'obras_ingreso');
        }

        function showRRHHModal(empleado) {
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            modalContentWrapper.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl mx-auto text-left flex flex-col" style="max-height: 90vh;">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h2 class="text-xl font-semibold">Recursos Humanos: ${empleado.nombre}</h2>
                        <button id="close-rrhh-modal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                    </div>
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6 px-6">
                            <button id="rrhh-tab-contratacion" class="dashboard-tab-btn active py-3 px-1 font-semibold">Datos y Contratación</button>
                            <button id="rrhh-tab-pagos" class="dashboard-tab-btn py-3 px-1 font-semibold">Pagos y Liquidaciones</button>
                            <button id="rrhh-tab-descargos" class="dashboard-tab-btn py-3 px-1 font-semibold">Descargos</button>
                        </nav>
                    </div>
                    <div class="p-6 overflow-y-auto flex-grow">
                        <div id="rrhh-view-contratacion"></div>
                        <div id="rrhh-view-pagos" class="hidden"></div>
                        <div id="rrhh-view-descargos" class="hidden"></div>
                    </div>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('close-rrhh-modal').addEventListener('click', hideModal);

            // Lógica de Tabs
            const contratacionTab = document.getElementById('rrhh-tab-contratacion');
            const pagosTab = document.getElementById('rrhh-tab-pagos');
            const descargosTab = document.getElementById('rrhh-tab-descargos');
            const contratacionView = document.getElementById('rrhh-view-contratacion');
            const pagosView = document.getElementById('rrhh-view-pagos');
            const descargosView = document.getElementById('rrhh-view-descargos');

            contratacionTab.addEventListener('click', () => {
                contratacionTab.classList.add('active');
                pagosTab.classList.remove('active');
                descargosTab.classList.remove('active');
                contratacionView.classList.remove('hidden');
                pagosView.classList.add('hidden');
                descargosView.classList.add('hidden');
            });
            pagosTab.addEventListener('click', () => {
                pagosTab.classList.add('active');
                contratacionTab.classList.remove('active');
                descargosTab.classList.remove('active');
                pagosView.classList.remove('hidden');
                contratacionView.classList.add('hidden');
                descargosView.classList.add('hidden');
            });
            descargosTab.addEventListener('click', () => {
                descargosTab.classList.add('active');
                contratacionTab.classList.remove('active');
                pagosTab.classList.remove('active');
                descargosView.classList.remove('hidden');
                contratacionView.classList.add('hidden');
                pagosView.classList.add('hidden');
            });

            // Renderizar contenido de cada tab
            renderContratacionTab(empleado, contratacionView);
            renderPagosTab(empleado, pagosView);
            renderDescargosTab(empleado, descargosView);
        }

    </script>
</body>
</html>
