<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión - Pintura Electrostática</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .modal { transition: opacity 0.3s ease; }
        .remision-id, .cliente-id, .item-ref { font-family: monospace; font-size: 0.8rem; background-color: #e5e7eb; padding: 2px 6px; border-radius: 4px; color: #4b5563; }
        .item-row:not(:last-child) { border-bottom: 1px solid #e5e7eb; padding-bottom: 1rem; margin-bottom: 1rem; }
        .tab-btn { transition: all 0.2s ease-in-out; border-bottom: 4px solid transparent; }
        .tab-btn.active { border-bottom-color: #4f46e5; color: #111827; }
        .dashboard-tab-btn { transition: all 0.2s ease-in-out; border-bottom: 2px solid transparent; }
        .dashboard-tab-btn.active { border-color: #4f46e5; color: #4f46e5; }
        .btn-disabled { cursor: not-allowed; background-color: #9ca3af !important; }
        .remision-anulada { background-color: #fee2e2; border-left: 4px solid #ef4444; }
        .status-badge { font-size: 0.75rem; padding: 0.2rem 0.6rem; border-radius: 9999px; font-weight: 600; }
        .status-recibido { background-color: #e0e7ff; color: #4338ca; }
        .status-en-proceso { background-color: #fef3c7; color: #b45309; }
        .status-procesado { background-color: #dbeafe; color: #1d4ed8; }
        .status-entregado { background-color: #dcfce7; color: #166534; }
        .payment-status { font-size: 0.7rem; padding: 0.1rem 0.5rem; border-radius: 9999px; font-weight: 600; border-width: 1px; }
        .payment-pagado { background-color: #dcfce7; color: #166534; border-color: #166534; }
        .payment-abono { background-color: #fef9c3; color: #a16207; border-color: #a16207; }
        .payment-pendiente { background-color: #fee2e2; color: #991b1b; border-color: #991b1b; }
    </style>
</head>
<body class="text-gray-800">

    <div id="auth-view" class="min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="w-full max-w-md">
            <form id="login-form" class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6">Iniciar Sesión</h2>
                <div class="space-y-4">
                    <input type="email" id="login-email" placeholder="Correo Electrónico" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <input type="password" id="login-password" placeholder="Contraseña" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700">Ingresar</button>
                </div>
                <p class="text-center mt-4 text-sm">¿No tienes una cuenta? <a href="#" id="show-register-link" class="font-semibold text-indigo-600 hover:underline">Regístrate aquí</a></p>
            </form>

            <form id="register-form" class="hidden bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold text-center mb-6">Crear Cuenta</h2>
                <div class="space-y-4">
                    <input type="text" id="register-name" placeholder="Nombre Completo" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <input type="tel" id="register-phone" placeholder="Celular" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <input type="email" id="register-email" placeholder="Correo Electrónico" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <input type="password" id="register-password" placeholder="Contraseña (mín. 6 caracteres)" class="w-full p-3 border border-gray-300 rounded-lg" required>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">Registrarse</button>
                </div>
                 <p class="text-center mt-4 text-sm">¿Ya tienes una cuenta? <a href="#" id="show-login-link" class="font-semibold text-indigo-600 hover:underline">Inicia sesión</a></p>
            </form>
        </div>
    </div>

    <div id="app-view" class="hidden min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            <header class="mb-6 flex flex-col sm:flex-row justify-between sm:items-center gap-4 sm:gap-0">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Sistema de Gestión Integral</h1>
                    <p id="user-info" class="text-gray-600 mt-1">Cargando usuario...</p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="summary-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Resumen</button>
                    <button id="logout-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Cerrar Sesión</button>
                </div>
            </header>

            <div class="border-b border-gray-200 mb-6">
                <nav id="main-nav" class="-mb-px flex space-x-6 overflow-x-auto">
                    <button id="tab-remisiones" class="tab-btn active py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap">Remisiones</button>
                    <button id="tab-clientes" class="tab-btn py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap">Clientes</button>
                    <button id="tab-items" class="tab-btn py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap">Ítems</button>
                    <button id="tab-colores" class="tab-btn py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap">Colores</button>
                    <button id="tab-gastos" class="tab-btn py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap">Gastos</button>
                    <button id="tab-proveedores" class="tab-btn py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap">Proveedores</button>
                    <button id="tab-empleados" class="tab-btn py-4 px-1 text-lg font-semibold text-gray-500 hover:text-gray-800 whitespace-nowrap hidden">Empleados</button>
                </nav>
            </div>

            <main>
                <div id="view-remisiones"></div>
                <div id="view-clientes" class="hidden"></div>
                <div id="view-items" class="hidden"></div>
                <div id="view-colores" class="hidden"></div>
                <div id="view-gastos" class="hidden"></div>
                <div id="view-proveedores" class="hidden"></div>
                <div id="view-empleados" class="hidden"></div>
            </main>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="modal-content-wrapper" class="w-full">
            <div id="modal-content" class="bg-white rounded-lg p-6 shadow-xl w-11/12 max-w-sm mx-auto text-center">
                </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, query, orderBy, onSnapshot, deleteDoc, updateDoc, addDoc, runTransaction, arrayUnion } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";
        
        // --- INICIALIZACIÓN Y CONFIGURACIÓN ---
        const firebaseConfig = {
            apiKey: "AIzaSyAOeIv-PnETZIs5NFrsxsBnqf2_Gt6hbKM",
            authDomain: "prismacolorsas.firebaseapp.com",
            storageBucket: "prismacolorsas.appspot.com",
            projectId: "prismacolorsas",
            messagingSenderId: "907757501037",
            appId: "1:907757501037:web:ab61eb771e12add9a29d64",
            measurementId: "G-T2RKG90GC5"
        };
        let app, auth, db, storage;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
        } catch (e) { console.error("Error al inicializar Firebase.", e); showModalMessage("Error de Configuración de Firebase."); }
        
        // --- VISTAS Y ESTADO GLOBAL ---
        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        let currentUser = null;
        let currentUserData = null;
        let allItems = [];
        let allColores = [];
        let allClientes = [];
        let allProveedores = [];
        let allGastos = [];
        let allRemisiones = [];
        let profitLossChart = null;
        const ESTADOS_REMISION = ['Recibido', 'En Proceso', 'Procesado', 'Entregado'];
        const ALL_MODULES = ['remisiones', 'clientes', 'items', 'colores', 'gastos', 'proveedores', 'empleados'];

        // --- MANEJO DE AUTENTICACIÓN Y VISTAS ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    currentUserData = userDoc.data();
                    document.getElementById('user-info').textContent = `Usuario: ${currentUserData.nombre} (${currentUserData.role})`;
                }
                authView.classList.add('hidden');
                appView.classList.remove('hidden');
                loadInitialData();
            } else {
                currentUser = null;
                currentUserData = null;
                authView.classList.remove('hidden');
                appView.classList.add('hidden');
            }
        });

        function updateUIVisibility(userData) {
            const nav = document.getElementById('main-nav');
            if (!userData || !nav) return;

            const permissions = userData.permissions || {};
            const isAdmin = userData.role && userData.role.toLowerCase() === 'admin';
            const isPlanta = userData.role && userData.role.toLowerCase() === 'planta';

            ALL_MODULES.forEach(module => {
                const tab = document.getElementById(`tab-${module}`);
                if (tab) {
                    const hasPermission = isAdmin || permissions[module];
                    if (hasPermission) {
                        tab.classList.remove('hidden');
                    } else {
                        tab.classList.add('hidden');
                    }
                }
            });
            
            const summaryBtn = document.getElementById('summary-btn');
            if(summaryBtn) {
                summaryBtn.style.display = (isPlanta) ? 'none' : '';
            }

            const remisionFormContainer = document.getElementById('remision-form-container');
            const remisionListContainer = document.getElementById('remisiones-list-container');
            if (remisionFormContainer && remisionListContainer) {
                if (isPlanta) {
                    remisionFormContainer.classList.add('hidden');
                    remisionListContainer.classList.remove('lg:col-span-2');
                    remisionListContainer.classList.add('lg:col-span-3');
                } else {
                    remisionFormContainer.classList.remove('hidden');
                    remisionListContainer.classList.add('lg:col-span-2');
                    remisionListContainer.classList.remove('lg:col-span-3');
                }
            }
        }

        function loadInitialData() {
            // Cargar plantillas HTML en las vistas
            document.getElementById('view-remisiones').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div id="remision-form-container" class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold mb-4">Nueva Remisión</h2><form id="remision-form" class="space-y-4"><select id="cliente-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white" required><option value="" disabled selected>Selecciona un Cliente</option></select><div><label for="fecha-recibido" class="block text-sm font-medium text-gray-700">Fecha Recibido</label><input type="date" id="fecha-recibido" class="w-full p-3 border border-gray-300 rounded-lg mt-1 bg-gray-100" readonly></div><div class="border-t border-b border-gray-200 py-4"><h3 class="text-lg font-semibold mb-2">Ítems de la Remisión</h3><div id="items-container" class="space-y-4"></div><button type="button" id="add-item-btn" class="mt-4 w-full bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors">+ Añadir Ítem</button></div><select id="forma-pago" class="w-full p-3 border border-gray-300 rounded-lg bg-white" required><option value="" disabled selected>Forma de Pago</option><option value="Pendiente">Pendiente</option><option value="Efectivo">Efectivo</option><option value="Nequi">Nequi</option><option value="Davivienda">Davivienda</option></select><div class="bg-gray-50 p-4 rounded-lg space-y-2"><div class="flex justify-between items-center"><span class="font-medium">Subtotal:</span><span id="subtotal" class="font-bold text-lg">$ 0</span></div><div class="flex justify-between items-center"><label for="incluir-iva" class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="incluir-iva" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"><span>Incluir IVA (19%)</span></label><span id="valor-iva" class="font-medium text-gray-600">$ 0</span></div><hr><div class="flex justify-between items-center text-xl"><span class="font-bold">TOTAL:</span><span id="valor-total" class="font-bold text-indigo-600">$ 0</span></div></div><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors">Guardar y Enviar Remisión</button></form></div><div id="remisiones-list-container" class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4 flex-wrap gap-4"><h2 class="text-xl font-semibold">Historial de Remisiones</h2><div class="flex items-center gap-2 flex-wrap"><select id="filter-remisiones-month" class="p-2 border rounded-lg bg-white"></select><select id="filter-remisiones-year" class="p-2 border rounded-lg bg-white"></select><input type="search" id="search-remisiones" placeholder="Buscar..." class="p-2 border rounded-lg w-full sm:w-40"></div></div><div id="remisiones-list" class="space-y-3"><p id="loading-remisiones" class="text-center text-gray-500 py-8">Cargando...</p></div></div></div>`;
            document.getElementById('view-clientes').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold mb-4">Añadir Nuevo Cliente</h2><form id="add-cliente-form" class="space-y-4"><input type="text" id="nuevo-cliente-nombre" placeholder="Nombre Completo" class="w-full p-3 border border-gray-300 rounded-lg" required><input type="email" id="nuevo-cliente-email" placeholder="Correo Electrónico" class="w-full p-3 border border-gray-300 rounded-lg" required><input type="tel" id="nuevo-cliente-telefono" placeholder="Teléfono" class="w-full p-3 border border-gray-300 rounded-lg" required><input type="text" id="nuevo-cliente-nit" placeholder="NIT (Opcional)" class="w-full p-3 border border-gray-300 rounded-lg"><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors">Registrar Cliente</button></form></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Clientes Registrados</h2><input type="search" id="search-clientes" placeholder="Buscar cliente..." class="p-2 border rounded-lg"></div><div id="clientes-list" class="space-y-3"><p id="loading-clientes" class="text-center text-gray-500 py-8">Cargando...</p></div></div></div>`;
            document.getElementById('view-proveedores').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold mb-4">Añadir Nuevo Proveedor</h2><form id="add-proveedor-form" class="space-y-4"><input type="text" id="nuevo-proveedor-nombre" placeholder="Nombre del Proveedor" class="w-full p-3 border border-gray-300 rounded-lg" required><input type="text" id="nuevo-proveedor-contacto" placeholder="Nombre de Contacto (Opcional)" class="w-full p-3 border border-gray-300 rounded-lg"><input type="tel" id="nuevo-proveedor-telefono" placeholder="Teléfono" class="w-full p-3 border border-gray-300 rounded-lg"><input type="email" id="nuevo-proveedor-email" placeholder="Correo Electrónico" class="w-full p-3 border border-gray-300 rounded-lg"><button type="submit" class="w-full bg-teal-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-700 transition-colors">Registrar Proveedor</button></form></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Proveedores Registrados</h2><input type="search" id="search-proveedores" placeholder="Buscar proveedor..." class="p-2 border rounded-lg"></div><div id="proveedores-list" class="space-y-3"><p id="loading-proveedores" class="text-center text-gray-500 py-8">Cargando...</p></div></div></div>`;
            document.getElementById('view-items').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold mb-4">Añadir Nuevo Ítem</h2><form id="add-item-form" class="space-y-4"><input type="text" id="nuevo-item-ref" placeholder="Referencia (ej. P-001)" class="w-full p-3 border border-gray-300 rounded-lg" required><input type="text" id="nuevo-item-desc" placeholder="Descripción del Ítem o Servicio" class="w-full p-3 border border-gray-300 rounded-lg" required><button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors">Registrar Ítem</button></form></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Catálogo de Ítems</h2><input type="search" id="search-items" placeholder="Buscar por ref. o desc..." class="p-2 border rounded-lg"></div><div id="items-list" class="space-y-3"><p id="loading-items" class="text-center text-gray-500 py-8">Cargando...</p></div></div></div>`;
            document.getElementById('view-colores').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold mb-4">Añadir Nuevo Color</h2><form id="add-color-form" class="space-y-4"><input type="text" id="nuevo-color-nombre" placeholder="Nombre del Color (ej. RAL 7016)" class="w-full p-3 border border-gray-300 rounded-lg" required><button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors">Registrar Color</button></form></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Catálogo de Colores</h2><input type="search" id="search-colores" placeholder="Buscar color..." class="p-2 border rounded-lg"></div><div id="colores-list" class="space-y-3"><p id="loading-colores" class="text-center text-gray-500 py-8">Cargando...</p></div></div></div>`;
            document.getElementById('view-gastos').innerHTML = `<div class="grid grid-cols-1 lg:grid-cols-3 gap-8"><div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold mb-4">Nuevo Gasto</h2><form id="add-gasto-form" class="space-y-4"><div><label for="gasto-fecha">Fecha</label><input type="date" id="gasto-fecha" class="w-full p-3 border border-gray-300 rounded-lg mt-1" required></div><select id="proveedor-select" class="w-full p-3 border border-gray-300 rounded-lg bg-white" required><option value="" disabled selected>Selecciona un Proveedor</option></select><input type="text" id="gasto-factura" placeholder="N° de Factura (Opcional)" class="w-full p-3 border border-gray-300 rounded-lg"><input type="text" id="gasto-valor-total" inputmode="numeric" placeholder="Valor Total" class="w-full p-3 border border-gray-300 rounded-lg" required><label class="flex items-center space-x-2"><input type="checkbox" id="gasto-iva" class="h-4 w-4 rounded border-gray-300"><span>IVA del 19% ya está incluido en el valor total</span></label><div><label for="gasto-fuente">Fuente del Pago</label><select id="gasto-fuente" class="w-full p-3 border border-gray-300 rounded-lg mt-1 bg-white" required><option value="Efectivo">Efectivo</option><option value="Nequi">Nequi</option><option value="Davivienda">Davivienda</option></select></div><button type="submit" class="w-full bg-orange-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-700">Registrar Gasto</button></form></div><div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md"><div class="flex justify-between items-center mb-4 flex-wrap gap-2"><h2 class="text-xl font-semibold">Historial de Gastos</h2><div class="flex items-center gap-2"><select id="filter-gastos-month" class="p-2 border rounded-lg bg-white"></select><select id="filter-gastos-year" class="p-2 border rounded-lg bg-white"></select><input type="search" id="search-gastos" placeholder="Buscar..." class="p-2 border rounded-lg w-40"></div></div><div id="gastos-list" class="space-y-3"><p id="loading-gastos" class="text-center text-gray-500 py-8">Cargando...</p></div></div></div>`;
            document.getElementById('view-empleados').innerHTML = `<div class="bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-semibold mb-4">Gestión de Empleados</h2><div id="empleados-list" class="space-y-3"></div></div>`;
            
            updateUIVisibility(currentUserData);
            loadClientes();
            loadProveedores();
            loadItems();
            loadColores();
            loadRemisiones();
            if (currentUserData && currentUserData.role === 'admin') loadEmpleados();
            setupEventListeners();
        }

        // --- LÓGICA DE LOGIN/REGISTRO/LOGOUT ---
        document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
        document.getElementById('show-login-link').addEventListener('click', (e) => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
        loginForm.addEventListener('submit', (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; signInWithEmailAndPassword(auth, email, password).catch(error => { console.error(error); showModalMessage("Error: " + error.message); }); });
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('register-name').value;
            const telefono = document.getElementById('register-phone').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            showModalMessage("Registrando...", true);
            try {
                const usersCollection = collection(db, "users");
                const existingUsers = await getDocs(query(usersCollection));
                const isFirstUser = existingUsers.empty;
                const role = isFirstUser ? 'admin' : 'planta';
                const permissions = { remisiones: true, clientes: !isFirstUser, items: !isFirstUser, colores: !isFirstUser, gastos: !isFirstUser, proveedores: !isFirstUser, empleados: isFirstUser };

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await setDoc(doc(db, "users", user.uid), { nombre, email, telefono, role, creadoEn: new Date(), permissions });
                hideModal();
                showModalMessage("¡Registro exitoso! Ahora puedes iniciar sesión.", false, 3000);
                registerForm.reset();
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            } catch (error) { hideModal(); console.error(error); showModalMessage("Error de registro: " + error.message); }
        });
        document.getElementById('logout-btn').addEventListener('click', () => { signOut(auth); });

        // --- LÓGICA DE NAVEGACIÓN Y EVENTOS ---
        function setupEventListeners() {
            const tabs = { remisiones: document.getElementById('tab-remisiones'), clientes: document.getElementById('tab-clientes'), items: document.getElementById('tab-items'), colores: document.getElementById('tab-colores'), gastos: document.getElementById('tab-gastos'), proveedores: document.getElementById('tab-proveedores'), empleados: document.getElementById('tab-empleados') };
            const views = { remisiones: document.getElementById('view-remisiones'), clientes: document.getElementById('view-clientes'), items: document.getElementById('view-items'), colores: document.getElementById('view-colores'), gastos: document.getElementById('view-gastos'), proveedores: document.getElementById('view-proveedores'), empleados: document.getElementById('view-empleados') };
            Object.keys(tabs).forEach(key => { if(tabs[key]) tabs[key].addEventListener('click', () => switchView(key, tabs, views)) });
            
            document.getElementById('add-color-form').addEventListener('submit', async (e) => { e.preventDefault(); const nuevoColor = { nombre: document.getElementById('nuevo-color-nombre').value, creadoEn: new Date() }; showModalMessage("Registrando color...", true); try { await addDoc(collection(db, "colores"), nuevoColor); e.target.reset(); hideModal(); showModalMessage("¡Color registrado!", false, 2000); } catch (error) { console.error(error); hideModal(); showModalMessage("Error al registrar color."); } });
            document.getElementById('add-item-form').addEventListener('submit', async (e) => { e.preventDefault(); const nuevoItem = { referencia: document.getElementById('nuevo-item-ref').value, descripcion: document.getElementById('nuevo-item-desc').value, creadoEn: new Date() }; showModalMessage("Registrando ítem...", true); try { await addDoc(collection(db, "items"), nuevoItem); e.target.reset(); hideModal(); showModalMessage("¡Ítem registrado!", false, 2000); } catch (error) { console.error(error); hideModal(); showModalMessage("Error al registrar ítem."); } });
            document.getElementById('add-cliente-form').addEventListener('submit', async (e) => { e.preventDefault(); const nuevoCliente = { nombre: document.getElementById('nuevo-cliente-nombre').value, email: document.getElementById('nuevo-cliente-email').value, telefono: document.getElementById('nuevo-cliente-telefono').value, nit: document.getElementById('nuevo-cliente-nit').value || '', creadoEn: new Date() }; showModalMessage("Registrando cliente...", true); try { await addDoc(collection(db, "clientes"), nuevoCliente); e.target.reset(); hideModal(); showModalMessage("¡Cliente registrado!", false, 2000); } catch (error) { console.error(error); hideModal(); showModalMessage("Error al registrar cliente."); } });
            document.getElementById('add-proveedor-form').addEventListener('submit', handleProveedorSubmit);
            document.getElementById('add-gasto-form').addEventListener('submit', handleGastoSubmit);
            document.getElementById('remision-form').addEventListener('submit', handleRemisionSubmit);
            document.getElementById('add-item-btn').addEventListener('click', () => {
                const itemsContainer = document.getElementById('items-container');
                if (itemsContainer) itemsContainer.appendChild(createItemElement());
            });
            const ivaCheckbox = document.getElementById('incluir-iva');
            if(ivaCheckbox) ivaCheckbox.addEventListener('input', calcularTotales);
            document.getElementById('summary-btn').addEventListener('click', showDashboardModal);

            // Listeners para buscadores
            document.getElementById('search-remisiones').addEventListener('input', renderRemisiones);
            document.getElementById('search-clientes').addEventListener('input', renderClientes);
            document.getElementById('search-proveedores').addEventListener('input', renderProveedores);
            document.getElementById('search-items').addEventListener('input', renderItems);
            document.getElementById('search-colores').addEventListener('input', renderColores);
            document.getElementById('search-gastos').addEventListener('input', renderGastos);
            
            // Listeners para filtros de fecha
            populateDateFilters('filter-remisiones');
            populateDateFilters('filter-gastos');
            document.getElementById('filter-remisiones-month').addEventListener('change', renderRemisiones);
            document.getElementById('filter-remisiones-year').addEventListener('change', renderRemisiones);
            document.getElementById('filter-gastos-month').addEventListener('change', renderGastos);
            document.getElementById('filter-gastos-year').addEventListener('change', renderGastos);
            
            // Fecha de recibido
            const fechaRecibidoInput = document.getElementById('fecha-recibido');
            if (fechaRecibidoInput) {
                fechaRecibidoInput.value = new Date().toISOString().split('T')[0];
            }

            // Listeners para formateo de moneda
            document.getElementById('view-gastos').addEventListener('focusout', (e) => { if (e.target.id === 'gasto-valor-total') { formatCurrencyInput(e.target); } });
            document.getElementById('view-gastos').addEventListener('focus', (e) => { if (e.target.id === 'gasto-valor-total') { unformatCurrencyInput(e.target); } });
            document.getElementById('view-remisiones').addEventListener('focusout', (e) => { if (e.target.classList.contains('item-valor-unitario')) { formatCurrencyInput(e.target); calcularTotales(); } });
            document.getElementById('view-remisiones').addEventListener('focus', (e) => { if (e.target.classList.contains('item-valor-unitario')) { unformatCurrencyInput(e.target); } });
        }

        function switchView(viewName, tabs, views) {
            Object.values(tabs).forEach(tab => { if(tab) tab.classList.remove('active') });
            Object.values(views).forEach(view => { if(view) view.classList.add('hidden') });
            if(tabs[viewName]) tabs[viewName].classList.add('active');
            if(views[viewName]) views[viewName].classList.remove('hidden');
        }

        // --- FUNCIONES DE CARGA Y RENDERIZADO DE DATOS ---
        function loadEmpleados() {
            const empleadosListEl = document.getElementById('empleados-list');
            if (!currentUserData || currentUserData.role !== 'admin' || !empleadosListEl) return;
            const q = query(collection(db, "users"));
            onSnapshot(q, (snapshot) => {
                const users = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                empleadosListEl.innerHTML = '';
                users.filter(u => u.id !== currentUser.uid).forEach(empleado => {
                    const el = document.createElement('div');
                    el.className = 'border p-4 rounded-lg flex justify-between items-center';
                    el.innerHTML = `<div><p class="font-semibold">${empleado.nombre} <span class="text-sm font-normal text-gray-500">(${empleado.role})</span></p><p class="text-sm text-gray-600">${empleado.email}</p></div><div class="flex gap-2"><button data-user-json='${JSON.stringify(empleado)}' class="manage-permissions-btn bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-semibold hover:bg-blue-700">Gestionar</button><button data-uid="${empleado.id}" class="delete-user-btn bg-red-600 text-white p-2 rounded hover:bg-red-700">Eliminar</button></div>`;
                    empleadosListEl.appendChild(el);
                });
                document.querySelectorAll('.manage-permissions-btn').forEach(btn => btn.addEventListener('click', (e) => showPermissionsModal(JSON.parse(e.currentTarget.dataset.userJson))));
                document.querySelectorAll('.delete-user-btn').forEach(btn => { btn.addEventListener('click', async (e) => { const uid = e.target.dataset.uid; if (confirm('¿Estás seguro de que quieres eliminar este usuario?')) { await deleteDoc(doc(db, "users", uid)); showModalMessage("Usuario eliminado de Firestore.", false, 2000); } }); });
            });
        }
        function loadColores() {
            const q = query(collection(db, "colores"), orderBy("nombre", "asc"));
            onSnapshot(q, (snapshot) => {
                allColores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderColores();
            });
        }
        function renderColores() {
            const coloresListEl = document.getElementById('colores-list');
            if (!coloresListEl) return;
            const searchTerm = document.getElementById('search-colores').value.toLowerCase();
            const filtered = allColores.filter(c => c.nombre.toLowerCase().includes(searchTerm));
            
            coloresListEl.innerHTML = '';
            if (filtered.length === 0) { coloresListEl.innerHTML = '<p>No hay colores.</p>'; return; }
            filtered.forEach(color => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'border p-4 rounded-lg font-semibold';
                colorDiv.textContent = color.nombre;
                coloresListEl.appendChild(colorDiv);
            });
        }
        function loadItems() {
             const q = query(collection(db, "items"), orderBy("referencia", "asc"));
            onSnapshot(q, (snapshot) => {
                allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderItems();
            });
        }
        function renderItems() {
            const itemsListEl = document.getElementById('items-list');
            if (!itemsListEl) return;
            const searchTerm = document.getElementById('search-items').value.toLowerCase();
            const filtered = allItems.filter(i => i.referencia.toLowerCase().includes(searchTerm) || i.descripcion.toLowerCase().includes(searchTerm));

            itemsListEl.innerHTML = '';
            if (filtered.length === 0) { itemsListEl.innerHTML = '<p>No hay ítems.</p>'; return; }
            filtered.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'border p-4 rounded-lg';
                itemDiv.innerHTML = `<p class="font-semibold"><span class="item-ref">${item.referencia}</span> ${item.descripcion}</p>`;
                itemsListEl.appendChild(itemDiv);
            });
        }
        function loadClientes() {
            const q = query(collection(db, "clientes"), orderBy("nombre", "asc"));
            onSnapshot(q, (snapshot) => {
                allClientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderClientes();
            });
        }
        function renderClientes() {
            const clientesListEl = document.getElementById('clientes-list');
            const clienteSelectEl = document.getElementById('cliente-select');
            if (!clientesListEl) return;
            const searchTerm = document.getElementById('search-clientes').value.toLowerCase();
            const filtered = allClientes.filter(c => c.nombre.toLowerCase().includes(searchTerm) || c.email.toLowerCase().includes(searchTerm) || c.telefono.includes(searchTerm));

            clientesListEl.innerHTML = '';
            if(clienteSelectEl) clienteSelectEl.innerHTML = '<option value="" disabled selected>Selecciona un Cliente</option>';
            if (filtered.length === 0) { clientesListEl.innerHTML = '<p>No hay clientes.</p>'; return; }
            
            allClientes.forEach(cliente => { // El dropdown siempre tiene todos los clientes
                 if(clienteSelectEl) {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nombre;
                    option.dataset.email = cliente.email;
                    clienteSelectEl.appendChild(option);
                }
            });

            filtered.forEach(cliente => {
                const clienteDiv = document.createElement('div');
                clienteDiv.className = 'border p-4 rounded-lg flex justify-between items-center';
                clienteDiv.innerHTML = `<div><p class="font-semibold">${cliente.nombre}</p><p class="text-sm text-gray-600">${cliente.email} | ${cliente.telefono}</p>${cliente.nit ? `<p class="text-sm text-gray-500">NIT: ${cliente.nit}</p>` : ''}</div><button data-client-json='${JSON.stringify(cliente)}' class="edit-client-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-sm font-semibold hover:bg-gray-300">Editar</button>`;
                clientesListEl.appendChild(clienteDiv);
            });
            document.querySelectorAll('.edit-client-btn').forEach(btn => btn.addEventListener('click', (e) => showEditClientModal(JSON.parse(e.currentTarget.dataset.clientJson))));
        }
        function loadProveedores() {
            const q = query(collection(db, "proveedores"), orderBy("nombre", "asc"));
            onSnapshot(q, (snapshot) => {
                allProveedores = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderProveedores();
            });
        }
        function renderProveedores() {
            const proveedoresListEl = document.getElementById('proveedores-list');
            const proveedorSelectEl = document.getElementById('proveedor-select');
            if (!proveedoresListEl) return;
            const searchTerm = document.getElementById('search-proveedores').value.toLowerCase();
            const filtered = allProveedores.filter(p => p.nombre.toLowerCase().includes(searchTerm));

            proveedoresListEl.innerHTML = '';
            if(proveedorSelectEl) proveedorSelectEl.innerHTML = '<option value="" disabled selected>Selecciona un Proveedor</option>';
            if (filtered.length === 0) { proveedoresListEl.innerHTML = '<p>No hay proveedores registrados.</p>'; return; }
            
            allProveedores.forEach(proveedor => { // El dropdown siempre tiene todos
                if(proveedorSelectEl) {
                    const option = document.createElement('option');
                    option.value = proveedor.id;
                    option.textContent = proveedor.nombre;
                    proveedorSelectEl.appendChild(option);
                }
            });

            filtered.forEach(proveedor => {
                const el = document.createElement('div');
                el.className = 'border p-4 rounded-lg';
                el.innerHTML = `<p class="font-semibold">${proveedor.nombre}</p><p class="text-sm text-gray-600">${proveedor.email || ''} | ${proveedor.telefono || ''}</p>`;
                proveedoresListEl.appendChild(el);
            });
        }
        function loadRemisiones() {
            const q = query(collection(db, "remisiones"), orderBy("numeroRemision", "desc"));
            onSnapshot(q, (snapshot) => {
                allRemisiones = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRemisiones();
            });
        }
        function renderRemisiones() {
            const remisionesListEl = document.getElementById('remisiones-list');
            if(!remisionesListEl) return;

            const isPlanta = currentUserData && currentUserData.role === 'planta';
            const month = document.getElementById('filter-remisiones-month').value;
            const year = document.getElementById('filter-remisiones-year').value;
            const searchTerm = document.getElementById('search-remisiones').value.toLowerCase();

            let filtered = allRemisiones;

            if (isPlanta) {
                const allowedStates = ['Recibido', 'En Proceso', 'Procesado'];
                filtered = filtered.filter(r => allowedStates.includes(r.estado));
            }

            if (year !== 'all') {
                filtered = filtered.filter(r => new Date(r.fechaRecibido).getFullYear() == year);
            }
            if (month !== 'all') {
                filtered = filtered.filter(r => new Date(r.fechaRecibido).getMonth() == month);
            }
            if (searchTerm) {
                filtered = filtered.filter(r => r.clienteNombre.toLowerCase().includes(searchTerm) || r.numeroRemision.toString().includes(searchTerm));
            }

            remisionesListEl.innerHTML = '';
            if (filtered.length === 0) { remisionesListEl.innerHTML = '<p class="text-center text-gray-500 py-8">No se encontraron remisiones.</p>'; return; }
            filtered.forEach((remision) => {
                const el = document.createElement('div');
                const esAnulada = remision.estado === 'Anulada';
                const esEntregada = remision.estado === 'Entregado';
                el.className = `border p-4 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 ${esAnulada ? 'remision-anulada' : ''}`;
                
                const totalPagado = (remision.payments || []).reduce((sum, p) => sum + p.amount, 0);
                const saldoPendiente = remision.valorTotal - totalPagado;
                
                let paymentStatusBadge = '';
                if (esAnulada) {} else if (saldoPendiente <= 0) { paymentStatusBadge = `<span class="payment-status payment-pagado">Pagado</span>`; } else if (totalPagado > 0) { paymentStatusBadge = `<span class="payment-status payment-abono">Abono</span>`; } else { paymentStatusBadge = `<span class="payment-status payment-pendiente">Pendiente</span>`; }

                const pdfUrl = isPlanta ? remision.pdfPlantaUrl : remision.pdfUrl;
                const pdfButton = pdfUrl ? `<button data-pdf-url="${pdfUrl}" data-remision-num="${remision.numeroRemision}" class="view-pdf-btn w-full bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-green-700 transition text-center">Ver PDF</button>` : `<button class="w-full bg-gray-400 text-white px-4 py-2 rounded-lg text-sm font-semibold btn-disabled">Generando PDF...</button>`;
                const anularButton = esAnulada || esEntregada || isPlanta ? '' : `<button data-remision-id="${remision.id}" class="anular-btn w-full bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-yellow-600 transition">Anular</button>`;
                const pagosButton = esAnulada || isPlanta ? '' : `<button data-remision-json='${JSON.stringify(remision)}' class="payment-btn w-full bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-purple-700 transition">Pagos (${formatCurrency(saldoPendiente)})</button>`;

                const statusClasses = {'Recibido': 'status-recibido', 'En Proceso': 'status-en-proceso', 'Procesado': 'status-procesado', 'Entregado': 'status-entregado'};
                const statusBadge = `<span class="status-badge ${statusClasses[remision.estado] || ''}">${remision.estado}</span>`;

                let statusButton = '';
                const currentIndex = ESTADOS_REMISION.indexOf(remision.estado);
                if (!esAnulada && currentIndex < ESTADOS_REMISION.length - 1) {
                    const nextStatus = ESTADOS_REMISION[currentIndex + 1];
                    statusButton = `<button data-remision-id="${remision.id}" data-current-status="${remision.estado}" class="status-update-btn w-full bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm font-semibold hover:bg-indigo-600 transition">Mover a ${nextStatus}</button>`;
                }

                el.innerHTML = `
                    <div class="flex-grow">
                        <div class="flex items-center gap-3 flex-wrap">
                            <span class="remision-id">N° ${remision.numeroRemision}</span>
                            <p class="font-semibold text-lg">${remision.clienteNombre}</p>
                            ${statusBadge}
                            ${!isPlanta ? paymentStatusBadge : ''}
                            ${esAnulada ? '<span class="px-2 py-1 bg-red-200 text-red-800 text-xs font-bold rounded-full">ANULADA</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-600 mt-1">Recibido: ${remision.fechaRecibido} &bull; ${remision.fechaEntrega ? `Entregado: ${remision.fechaEntrega}` : 'Entrega: Pendiente'}</p>
                        ${!isPlanta ? `<p class="text-sm text-gray-600 mt-1">Total: <span class="font-bold">${formatCurrency(remision.valorTotal)}</span></p>` : ''}
                    </div>
                    <div class="grid grid-cols-2 gap-2 flex-shrink-0 w-full sm:max-w-xs">
                        ${statusButton}
                        ${pdfButton}
                        ${pagosButton}
                        ${anularButton}
                    </div>`;
                remisionesListEl.appendChild(el);
            });
            document.querySelectorAll('.anular-btn').forEach(button => button.addEventListener('click', (e) => { const remisionId = e.currentTarget.dataset.remisionId; if(confirm(`¿Estás seguro de que quieres ANULAR esta remisión? Se enviará un correo de notificación al cliente.`)) { handleAnularRemision(remisionId); } }));
            document.querySelectorAll('.status-update-btn').forEach(button => button.addEventListener('click', (e) => { const remisionId = e.currentTarget.dataset.remisionId; const currentStatus = e.currentTarget.dataset.currentStatus; handleStatusUpdate(remisionId, currentStatus); }));
            document.querySelectorAll('.view-pdf-btn').forEach(button => button.addEventListener('click', (e) => { const pdfUrl = e.currentTarget.dataset.pdfUrl; const remisionNum = e.currentTarget.dataset.remisionNum; showPdfModal(pdfUrl, remisionNum); }));
            document.querySelectorAll('.payment-btn').forEach(button => button.addEventListener('click', (e) => { const remision = JSON.parse(e.currentTarget.dataset.remisionJson); showPaymentModal(remision); }));
        }
        function loadGastos() {
            const q = query(collection(db, "gastos"), orderBy("fecha", "desc"));
            onSnapshot(q, (snapshot) => {
                allGastos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderGastos();
            });
        }
        function renderGastos() {
            const gastosListEl = document.getElementById('gastos-list');
            if(!gastosListEl) return;

            const month = document.getElementById('filter-gastos-month').value;
            const year = document.getElementById('filter-gastos-year').value;
            const searchTerm = document.getElementById('search-gastos').value.toLowerCase();
            
            let filtered = allGastos;

            if (year !== 'all') {
                filtered = filtered.filter(g => new Date(g.fecha).getFullYear() == year);
            }
            if (month !== 'all') {
                filtered = filtered.filter(g => new Date(g.fecha).getMonth() == month);
            }
            if (searchTerm) {
                filtered = filtered.filter(g => g.proveedorNombre.toLowerCase().includes(searchTerm) || (g.numeroFactura && g.numeroFactura.toLowerCase().includes(searchTerm)));
            }

            gastosListEl.innerHTML = '';
            if (filtered.length === 0) { gastosListEl.innerHTML = '<p class="text-center text-gray-500 py-8">No hay gastos registrados.</p>'; return; }
            filtered.forEach((gasto) => {
                const el = document.createElement('div');
                el.className = 'border p-4 rounded-lg flex justify-between items-center';
                el.innerHTML = `
                    <div>
                        <p class="font-semibold">${gasto.proveedorNombre}</p>
                        <p class="text-sm text-gray-600">${gasto.fecha} ${gasto.numeroFactura ? `| Factura: ${gasto.numeroFactura}` : ''}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg text-red-600">${formatCurrency(gasto.valorTotal)}</p>
                        <p class="text-sm text-gray-500">Pagado con: ${gasto.fuentePago}</p>
                    </div>
                `;
                gastosListEl.appendChild(el);
            });
        }
        
        // --- FUNCIONES DE MANEJO DE ACCIONES ---
        async function handleProveedorSubmit(e) { e.preventDefault(); const nuevoProveedor = { nombre: document.getElementById('nuevo-proveedor-nombre').value, contacto: document.getElementById('nuevo-proveedor-contacto').value, telefono: document.getElementById('nuevo-proveedor-telefono').value, email: document.getElementById('nuevo-proveedor-email').value, creadoEn: new Date(), }; showModalMessage("Registrando proveedor...", true); try { await addDoc(collection(db, "proveedores"), nuevoProveedor); e.target.reset(); hideModal(); showModalMessage("¡Proveedor registrado!", false, 2000); } catch (error) { console.error("Error al registrar proveedor:", error); hideModal(); showModalMessage("Error al registrar el proveedor."); } }
        async function handleGastoSubmit(e) { e.preventDefault(); const valorTotal = unformatCurrency(document.getElementById('gasto-valor-total').value); const ivaIncluido = document.getElementById('gasto-iva').checked; const valorBase = ivaIncluido ? valorTotal / 1.19 : valorTotal; const proveedorSelect = document.getElementById('proveedor-select'); const proveedorNombre = proveedorSelect.options[proveedorSelect.selectedIndex].textContent; const nuevoGasto = { fecha: document.getElementById('gasto-fecha').value, proveedorId: proveedorSelect.value, proveedorNombre: proveedorNombre, numeroFactura: document.getElementById('gasto-factura').value, valorBase: valorBase, ivaIncluido: ivaIncluido, valorTotal: valorTotal, fuentePago: document.getElementById('gasto-fuente').value, registradoPor: currentUser.uid, timestamp: new Date(), }; showModalMessage("Registrando gasto...", true); try { await addDoc(collection(db, "gastos"), nuevoGasto); e.target.reset(); hideModal(); showModalMessage("¡Gasto registrado con éxito!", false, 2000); } catch (error) { console.error("Error al registrar gasto:", error); hideModal(); showModalMessage("Error al registrar el gasto."); } }
        async function handleStatusUpdate(remisionId, currentStatus) { const currentIndex = ESTADOS_REMISION.indexOf(currentStatus); if (currentIndex < ESTADOS_REMISION.length - 1) { const nextStatus = ESTADOS_REMISION[currentIndex + 1]; const updateData = { estado: nextStatus }; if (nextStatus === 'Entregado') { updateData.fechaEntrega = new Date().toISOString().split('T')[0]; } showModalMessage("Actualizando estado...", true); try { await updateDoc(doc(db, "remisiones", remisionId), updateData); hideModal(); } catch (error) { console.error("Error al actualizar estado:", error); showModalMessage("Error al actualizar estado."); } } }
        async function handleAnularRemision(remisionId) { showModalMessage("Anulando remisión...", true); try { const remisionRef = doc(db, "remisiones", remisionId); await updateDoc(remisionRef, { estado: "Anulada" }); hideModal(); showModalMessage("¡Remisión anulada con éxito!", false, 2000); } catch (error) { console.error("Error al anular la remisión:", error); hideModal(); showModalMessage("Error al anular la remisión."); } }
        async function handleRemisionSubmit(e) { e.preventDefault(); const clienteSelectEl = document.getElementById('cliente-select'); const itemsContainer = document.getElementById('items-container'); if (!currentUser || !clienteSelectEl.value) { showModalMessage("Debes seleccionar un cliente."); return; } if (itemsContainer.children.length === 0) { showModalMessage("Debes añadir al menos un ítem."); return; } showModalMessage("Guardando remisión...", true); const counterRef = doc(db, "counters", "remisionCounter"); try { const newRemisionNumber = await runTransaction(db, async (transaction) => { const counterDoc = await transaction.get(counterRef); if (!counterDoc.exists()) { transaction.set(counterRef, { currentNumber: 1 }); return 1; } const newNumber = counterDoc.data().currentNumber + 1; transaction.update(counterRef, { currentNumber: newNumber }); return newNumber; }); const { subtotalGeneral, valorIVA, total } = calcularTotales(); const selectedCliente = clienteSelectEl.options[clienteSelectEl.selectedIndex]; const items = Array.from(itemsContainer.querySelectorAll('.item-row')).map(row => { const selectedItem = row.querySelector('.item-select').options[row.querySelector('.item-select').selectedIndex]; return { itemId: selectedItem.value, referencia: selectedItem.dataset.ref, descripcion: selectedItem.dataset.desc, color: row.querySelector('.item-color-select').value, cantidad: parseFloat(row.querySelector('.item-cantidad').value) || 0, valorUnitario: unformatCurrency(row.querySelector('.item-valor-unitario').value) || 0, }; }); const formaDePago = document.getElementById('forma-pago').value; const initialPayments = []; if (formaDePago !== 'Pendiente') { initialPayments.push({ amount: total, date: document.getElementById('fecha-recibido').value, method: formaDePago, registeredAt: new Date() }); } const nuevaRemision = { numeroRemision: newRemisionNumber, idCliente: selectedCliente.value, clienteNombre: selectedCliente.textContent, clienteEmail: selectedCliente.dataset.email, fechaRecibido: document.getElementById('fecha-recibido').value, fechaEntrega: null, formaPago: formaDePago, incluyeIVA: document.getElementById('incluir-iva').checked, items: items, subtotal: subtotalGeneral, valorIVA: valorIVA, valorTotal: total, creadoPor: currentUser.uid, timestamp: new Date(), pdfUrl: null, emailStatus: 'pending', estado: 'Recibido', payments: initialPayments }; await addDoc(collection(db, "remisiones"), nuevaRemision); e.target.reset(); itemsContainer.innerHTML = ''; itemsContainer.appendChild(createItemElement()); calcularTotales(); hideModal(); showModalMessage("¡Remisión guardada! Se está procesando el correo.", false, 3000); document.getElementById('fecha-recibido').value = new Date().toISOString().split('T')[0]; } catch (error) { console.error("Error en la transacción o al crear la remisión: ", error); hideModal(); showModalMessage("Error al generar el número de remisión."); } }

        // --- FUNCIONES DE AYUDA Y MODALES ---
        function createItemElement() { const itemRow = document.createElement('div'); itemRow.className = 'item-row grid grid-cols-1 gap-2'; const itemSelectHTML = `<select class="item-select w-full p-2 border border-gray-300 rounded-lg" required><option value="" disabled selected>Selecciona un Ítem</option>${allItems.map(item => `<option value="${item.id}" data-ref="${item.referencia}" data-desc="${item.descripcion}">${item.referencia} - ${item.descripcion}</option>`).join('')}</select>`; const colorSelectHTML = `<select class="item-color-select w-full p-2 border border-gray-300 rounded-lg" required><option value="" disabled selected>Selecciona un Color</option>${allColores.map(color => `<option value="${color.nombre}">${color.nombre}</option>`).join('')}</select>`; itemRow.innerHTML = `${itemSelectHTML}${colorSelectHTML}<div class="grid grid-cols-3 gap-2"><input type="number" class="item-cantidad p-2 border border-gray-300 rounded-lg" placeholder="Cant." min="1" required><input type="text" inputmode="numeric" class="item-valor-unitario p-2 border border-gray-300 rounded-lg" placeholder="Vlr. Unit." required><button type="button" class="remove-item-btn bg-red-500 text-white font-bold rounded-lg hover:bg-red-600">Eliminar</button></div>`; itemRow.querySelector('.remove-item-btn').addEventListener('click', () => { itemRow.remove(); calcularTotales(); }); itemRow.querySelectorAll('input, select').forEach(input => input.addEventListener('input', calcularTotales)); return itemRow; }
        function calcularTotales() { const itemsContainer = document.getElementById('items-container'); const ivaCheckbox = document.getElementById('incluir-iva'); const subtotalEl = document.getElementById('subtotal'); const valorIvaEl = document.getElementById('valor-iva'); const valorTotalEl = document.getElementById('valor-total'); if(!itemsContainer || !ivaCheckbox || !subtotalEl || !valorIvaEl || !valorTotalEl) return {subtotalGeneral: 0, valorIVA: 0, total: 0}; let subtotalGeneral = 0; itemsContainer.querySelectorAll('.item-row').forEach(row => { const cantidad = parseFloat(row.querySelector('.item-cantidad').value) || 0; const valorUnitario = unformatCurrency(row.querySelector('.item-valor-unitario').value); subtotalGeneral += cantidad * valorUnitario; }); const incluyeIVA = ivaCheckbox.checked; const valorIVA = incluyeIVA ? subtotalGeneral * 0.19 : 0; const total = subtotalGeneral + valorIVA; subtotalEl.textContent = formatCurrency(subtotalGeneral); valorIvaEl.textContent = formatCurrency(valorIVA); valorTotalEl.textContent = formatCurrency(total); return { subtotalGeneral, valorIVA, total }; }
        function showEditClientModal(client) { const modalContentWrapper = document.getElementById('modal-content-wrapper'); modalContentWrapper.innerHTML = `<div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full text-center"><h2 class="text-xl font-semibold mb-4">Editar Cliente</h2><form id="edit-client-form" class="space-y-4 text-left"><input type="hidden" id="edit-client-id" value="${client.id}"><div><label for="edit-client-name" class="block text-sm font-medium text-gray-700">Nombre</label><input type="text" id="edit-client-name" class="w-full p-2 border border-gray-300 rounded-lg mt-1" value="${client.nombre}" required></div><div><label for="edit-client-email" class="block text-sm font-medium text-gray-700">Correo</label><input type="email" id="edit-client-email" class="w-full p-2 border border-gray-300 rounded-lg mt-1" value="${client.email}" required></div><div><label for="edit-client-phone" class="block text-sm font-medium text-gray-700">Teléfono</label><input type="tel" id="edit-client-phone" class="w-full p-2 border border-gray-300 rounded-lg mt-1" value="${client.telefono}" required></div><div><label for="edit-client-nit" class="block text-sm font-medium text-gray-700">NIT</label><input type="text" id="edit-client-nit" class="w-full p-2 border border-gray-300 rounded-lg mt-1" value="${client.nit || ''}"></div><div class="flex gap-4 justify-end pt-4"><button type="button" id="cancel-edit-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-semibold">Cancelar</button><button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold">Guardar Cambios</button></div></form></div>`; document.getElementById('modal').classList.remove('hidden'); document.getElementById('cancel-edit-btn').addEventListener('click', hideModal); document.getElementById('edit-client-form').addEventListener('submit', async (e) => { e.preventDefault(); const clientId = document.getElementById('edit-client-id').value; const updatedData = { nombre: document.getElementById('edit-client-name').value, email: document.getElementById('edit-client-email').value, telefono: document.getElementById('edit-client-phone').value, nit: document.getElementById('edit-client-nit').value, }; showModalMessage("Actualizando cliente...", true); try { await updateDoc(doc(db, "clientes", clientId), updatedData); hideModal(); showModalMessage("¡Cliente actualizado!", false, 2000); } catch (error) { console.error("Error al actualizar cliente:", error); showModalMessage("Error al actualizar."); } }); }
        function showPdfModal(pdfUrl, remisionNum) { const modalContentWrapper = document.getElementById('modal-content-wrapper'); modalContentWrapper.innerHTML = `<div class="bg-white rounded-lg shadow-xl w-full max-w-6xl flex flex-col" style="height: 80vh;"><div class="flex justify-between items-center p-4 border-b"><h2 class="text-xl font-semibold">Visor de Remisión N° ${remisionNum}</h2><button id="close-pdf-modal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div class="flex-grow p-2 bg-gray-200"><iframe id="pdf-iframe" src="${pdfUrl}" class="w-full h-full" frameborder="0"></iframe></div></div>`; document.getElementById('modal').classList.remove('hidden'); document.getElementById('close-pdf-modal').addEventListener('click', hideModal); }
        function showPaymentModal(remision) { const modalContentWrapper = document.getElementById('modal-content-wrapper'); const totalPagado = (remision.payments || []).reduce((sum, p) => sum + p.amount, 0); const saldoPendiente = remision.valorTotal - totalPagado; const paymentsHTML = (remision.payments || []).map(p => `<tr class="border-b"><td class="p-2">${p.date}</td><td class="p-2">${p.method}</td><td class="p-2 text-right">${formatCurrency(p.amount)}</td></tr>`).join(''); modalContentWrapper.innerHTML = `<div class="bg-white rounded-lg p-6 shadow-xl max-w-2xl w-full text-left"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">Gestionar Pagos (Remisión N° ${remision.numeroRemision})</h2><button id="close-payment-modal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button></div><div class="grid grid-cols-3 gap-4 mb-4 text-center"><div class="bg-blue-50 p-3 rounded-lg"><div class="text-sm text-blue-800">VALOR TOTAL</div><div class="font-bold text-lg">${formatCurrency(remision.valorTotal)}</div></div><div class="bg-green-50 p-3 rounded-lg"><div class="text-sm text-green-800">TOTAL PAGADO</div><div class="font-bold text-lg">${formatCurrency(totalPagado)}</div></div><div class="bg-red-50 p-3 rounded-lg"><div class="text-sm text-red-800">SALDO PENDIENTE</div><div class="font-bold text-lg">${formatCurrency(saldoPendiente)}</div></div></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 class="font-semibold mb-2">Historial de Pagos</h3><div class="border rounded-lg max-h-60 overflow-y-auto"><table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="p-2 text-left">Fecha</th><th class="p-2 text-left">Método</th><th class="p-2 text-right">Monto</th></tr></thead><tbody>${paymentsHTML || '<tr><td colspan="3" class="p-4 text-center text-gray-500">No hay pagos registrados.</td></tr>'}</tbody></table></div></div><div><h3 class="font-semibold mb-2">Registrar Nuevo Pago</h3>${saldoPendiente > 0 ? `<form id="add-payment-form" class="space-y-3 bg-gray-50 p-4 rounded-lg"><div><label for="new-payment-amount" class="text-sm font-medium">Monto del Abono</label><input type="text" inputmode="numeric" id="new-payment-amount" class="w-full p-2 border rounded-md mt-1" max="${saldoPendiente}" required></div><div><label for="new-payment-date" class="text-sm font-medium">Fecha del Pago</label><input type="date" id="new-payment-date" class="w-full p-2 border rounded-md mt-1" value="${new Date().toISOString().split('T')[0]}" required></div><div><label for="new-payment-method" class="text-sm font-medium">Método de Pago</label><select id="new-payment-method" class="w-full p-2 border rounded-md mt-1 bg-white" required><option value="Efectivo">Efectivo</option><option value="Nequi">Nequi</option><option value="Davivienda">Davivienda</option></select></div><button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Registrar Pago</button></form>` : '<div class="bg-green-100 text-green-800 p-4 rounded-lg text-center font-semibold">Esta remisión ya ha sido pagada en su totalidad.</div>'}</div></div></div>`; document.getElementById('modal').classList.remove('hidden'); document.getElementById('close-payment-modal').addEventListener('click', hideModal); if (saldoPendiente > 0) { const paymentAmountInput = document.getElementById('new-payment-amount'); paymentAmountInput.addEventListener('focus', (e) => unformatCurrencyInput(e.target)); paymentAmountInput.addEventListener('blur', (e) => formatCurrencyInput(e.target)); document.getElementById('add-payment-form').addEventListener('submit', async (e) => { e.preventDefault(); const amount = unformatCurrency(paymentAmountInput.value); if (amount <= 0 || !amount) { alert("El monto debe ser mayor a cero."); return; } if (amount > saldoPendiente + 0.01) { alert("El monto del pago no puede superar el saldo pendiente."); return; } const newPayment = { amount: amount, date: document.getElementById('new-payment-date').value, method: document.getElementById('new-payment-method').value, registeredAt: new Date() }; showModalMessage("Registrando pago...", true); try { await updateDoc(doc(db, "remisiones", remision.id), { payments: arrayUnion(newPayment) }); hideModal(); showModalMessage("¡Pago registrado!", false, 2000); } catch (error) { console.error("Error al registrar pago:", error); showModalMessage("Error al registrar el pago."); } }); } }
        function showDashboardModal() {
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            
            modalContentWrapper.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl w-full max-w-6xl text-left flex flex-col" style="height: 80vh;">
                    <div class="flex justify-between items-center p-4 border-b">
                        <h2 class="text-xl font-semibold">Resumen Financiero</h2>
                        <div class="flex items-center gap-4">
                            <button id="download-report-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Descargar Reporte PDF</button>
                            <button id="close-dashboard-modal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                        </div>
                    </div>
                    <div class="border-b border-gray-200">
                        <nav class="-mb-px flex space-x-6 px-6">
                            <button id="dashboard-tab-summary" class="dashboard-tab-btn active py-4 px-1 font-semibold">Resumen Mensual</button>
                            <button id="dashboard-tab-cartera" class="dashboard-tab-btn py-4 px-1 font-semibold">Cartera</button>
                        </nav>
                    </div>
                    <div id="dashboard-summary-view" class="p-6 space-y-6 overflow-y-auto flex-grow"> <div class="flex items-center gap-4"><select id="summary-month" class="p-2 border rounded-lg"></select><select id="summary-year" class="p-2 border rounded-lg"></select></div><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"><div class="bg-green-100 p-4 rounded-lg"><div class="text-sm font-semibold text-green-800">VENTAS</div><div id="summary-sales" class="text-2xl font-bold"></div></div><div class="bg-red-100 p-4 rounded-lg"><div class="text-sm font-semibold text-red-800">GASTOS</div><div id="summary-expenses" class="text-2xl font-bold"></div></div><div class="bg-indigo-100 p-4 rounded-lg"><div class="text-sm font-semibold text-indigo-800">UTILIDAD/PÉRDIDA</div><div id="summary-profit" class="text-2xl font-bold"></div></div><div class="bg-yellow-100 p-4 rounded-lg"><div class="text-sm font-semibold text-yellow-800">CARTERA PENDIENTE (MES)</div><div id="summary-cartera" class="text-2xl font-bold"></div></div></div><div><h3 class="font-semibold mb-2">Saldos Estimados (Total)</h3><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"><div class="bg-gray-100 p-4 rounded-lg"><div class="text-sm font-semibold text-gray-800">EFECTIVO</div><div id="summary-efectivo" class="text-xl font-bold"></div></div><div class="bg-gray-100 p-4 rounded-lg"><div class="text-sm font-semibold text-gray-800">NEQUI</div><div id="summary-nequi" class="text-xl font-bold"></div></div><div class="bg-gray-100 p-4 rounded-lg"><div class="text-sm font-semibold text-gray-800">DAVIVIENDA</div><div id="summary-davivienda" class="text-xl font-bold"></div></div><div class="bg-gray-100 p-4 rounded-lg"><div class="text-sm font-semibold text-gray-800">CARTERA TOTAL</div><div id="summary-cartera-total" class="text-xl font-bold"></div></div></div></div><div><h3 class="font-semibold mb-2">Utilidad/Pérdida (Últimos 6 Meses)</h3><div class="bg-gray-50 p-4 rounded-lg"><canvas id="profitLossChart"></canvas></div></div></div>
                    <div id="dashboard-cartera-view" class="p-6 hidden flex-grow overflow-y-auto"><h3 class="font-semibold mb-2 text-xl">Cartera Pendiente de Cobro</h3><div id="cartera-list" class="space-y-3"></div><div id="cartera-total" class="text-right font-bold text-xl mt-4"></div></div>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('close-dashboard-modal').addEventListener('click', hideModal);

            const monthSelect = document.getElementById('summary-month');
            const yearSelect = document.getElementById('summary-year');
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const now = new Date();
            for (let i = 0; i < 12; i++) { const option = document.createElement('option'); option.value = i; option.textContent = monthNames[i]; if (i === now.getMonth()) option.selected = true; monthSelect.appendChild(option); }
            for (let i = 0; i < 5; i++) { const year = now.getFullYear() - i; const option = document.createElement('option'); option.value = year; option.textContent = year; yearSelect.appendChild(option); }
            
            const updateDashboardView = () => updateDashboard(parseInt(yearSelect.value), parseInt(monthSelect.value));
            monthSelect.addEventListener('change', updateDashboardView);
            yearSelect.addEventListener('change', updateDashboardView);

            const summaryTab = document.getElementById('dashboard-tab-summary');
            const carteraTab = document.getElementById('dashboard-tab-cartera');
            const summaryView = document.getElementById('dashboard-summary-view');
            const carteraView = document.getElementById('dashboard-cartera-view');
            summaryTab.addEventListener('click', () => { summaryTab.classList.add('active'); carteraTab.classList.remove('active'); summaryView.classList.remove('hidden'); carteraView.classList.add('hidden'); });
            carteraTab.addEventListener('click', () => { carteraTab.classList.add('active'); summaryTab.classList.remove('active'); carteraView.classList.remove('hidden'); summaryView.classList.add('hidden'); });

            document.getElementById('download-report-btn').addEventListener('click', showReportDateRangeModal);
            
            updateDashboardView();
            renderCartera();
        }
        function updateDashboard(year, month) { const salesThisMonth = allRemisiones.flatMap(r => r.payments || []).filter(p => { const d = new Date(p.date); return d.getMonth() === month && d.getFullYear() === year; }).reduce((sum, p) => sum + p.amount, 0); const expensesThisMonth = allGastos.filter(g => { const d = new Date(g.fecha); return d.getMonth() === month && d.getFullYear() === year; }).reduce((sum, g) => sum + g.valorTotal, 0); document.getElementById('summary-sales').textContent = formatCurrency(salesThisMonth); document.getElementById('summary-expenses').textContent = formatCurrency(expensesThisMonth); document.getElementById('summary-profit').textContent = formatCurrency(salesThisMonth - expensesThisMonth); const totalCartera = allRemisiones.filter(r => r.estado !== 'Anulada').reduce((sum, r) => { const totalPagado = (r.payments || []).reduce((s, p) => s + p.amount, 0); const saldo = r.valorTotal - totalPagado; return sum + (saldo > 0 ? saldo : 0); }, 0); document.getElementById('summary-cartera').textContent = formatCurrency(totalCartera); document.getElementById('summary-cartera-total').textContent = formatCurrency(totalCartera); const accountBalances = { Efectivo: 0, Nequi: 0, Davivienda: 0 }; allRemisiones.forEach(r => (r.payments || []).forEach(p => { if(accountBalances[p.method] !== undefined) accountBalances[p.method] += p.amount; })); allGastos.forEach(g => { if(accountBalances[g.fuentePago] !== undefined) accountBalances[g.fuentePago] -= g.valorTotal; }); document.getElementById('summary-efectivo').textContent = formatCurrency(accountBalances.Efectivo); document.getElementById('summary-nequi').textContent = formatCurrency(accountBalances.Nequi); document.getElementById('summary-davivienda').textContent = formatCurrency(accountBalances.Davivienda); const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"]; const labels = []; const salesData = []; const expensesData = []; for (let i = 5; i >= 0; i--) { const d = new Date(); d.setMonth(d.getMonth() - i); const m = d.getMonth(); const y = d.getFullYear(); labels.push(monthNames[m]); const monthlySales = allRemisiones.flatMap(r => r.payments || []).filter(p => { const pDate = new Date(p.date); return pDate.getMonth() === m && pDate.getFullYear() === y; }).reduce((sum, p) => sum + p.amount, 0); const monthlyExpenses = allGastos.filter(g => { const gDate = new Date(g.fecha); return gDate.getMonth() === m && gDate.getFullYear() === y; }).reduce((sum, g) => sum + g.valorTotal, 0); salesData.push(monthlySales); expensesData.push(monthlyExpenses); } const ctx = document.getElementById('profitLossChart').getContext('2d'); if (profitLossChart) { profitLossChart.destroy(); } profitLossChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Ventas', data: salesData, backgroundColor: 'rgba(75, 192, 192, 0.6)' }, { label: 'Gastos', data: expensesData, backgroundColor: 'rgba(255, 99, 132, 0.6)' }] }, options: { scales: { y: { beginAtZero: true } } } }); }
        function renderCartera() { const carteraListEl = document.getElementById('cartera-list'); const carteraTotalEl = document.getElementById('cartera-total'); const pendingRemisiones = allRemisiones.filter(r => { if (r.estado === 'Anulada') return false; const totalPagado = (r.payments || []).reduce((sum, p) => sum + p.amount, 0); return r.valorTotal - totalPagado > 0.01; }).sort((a, b) => new Date(a.fechaRecibido) - new Date(b.fechaRecibido)); if (pendingRemisiones.length === 0) { carteraListEl.innerHTML = '<p class="text-center text-gray-500 py-8">¡No hay cartera pendiente!</p>'; carteraTotalEl.innerHTML = ''; return; } let totalCartera = 0; carteraListEl.innerHTML = `<table class="w-full text-sm text-left"><thead class="bg-gray-50"><tr><th class="p-2">N° Remisión</th><th class="p-2">Cliente</th><th class="p-2">Fecha Recibido</th><th class="p-2 text-right">Valor Total</th><th class="p-2 text-right">Saldo Pendiente</th></tr></thead><tbody></tbody></table>`; const tbody = carteraListEl.querySelector('tbody'); pendingRemisiones.forEach(r => { const totalPagado = (r.payments || []).reduce((sum, p) => sum + p.amount, 0); const saldoPendiente = r.valorTotal - totalPagado; totalCartera += saldoPendiente; const row = document.createElement('tr'); row.className = 'border-b'; row.innerHTML = `<td class="p-2">${r.numeroRemision}</td><td class="p-2">${r.clienteNombre}</td><td class="p-2">${r.fechaRecibido}</td><td class="p-2 text-right">${formatCurrency(r.valorTotal)}</td><td class="p-2 text-right font-bold text-red-600">${formatCurrency(saldoPendiente)}</td>`; tbody.appendChild(row); }); carteraTotalEl.innerHTML = `Total Cartera: <span class="text-red-600">${formatCurrency(totalCartera)}</span>`; }
        const modal = document.getElementById('modal');
        let modalTimeout;
        function showModalMessage(message, isLoader = false, duration = 0) { const modalContentWrapper = document.getElementById('modal-content-wrapper'); modalContentWrapper.innerHTML = `<div id="modal-content" class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full text-center"></div>`; const modalContent = document.getElementById('modal-content'); clearTimeout(modalTimeout); modalContent.innerHTML = isLoader ? `<svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="mt-4 text-gray-700 font-semibold">${message}</p>` : `<p class="text-gray-800 font-semibold">${message}</p>`; modal.classList.remove('hidden'); if (duration > 0) modalTimeout = setTimeout(hideModal, duration); }
        function hideModal() { modal.classList.add('hidden'); }
        function formatCurrency(value) { return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(value); }
        function populateDateFilters(prefix) {
            const monthSelect = document.getElementById(`${prefix}-month`);
            const yearSelect = document.getElementById(`${prefix}-year`);
            if (!monthSelect || !yearSelect) return;

            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            monthSelect.innerHTML = '<option value="all">Todos los Meses</option>';
            for (let i = 0; i < 12; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = monthNames[i];
                monthSelect.appendChild(option);
            }

            yearSelect.innerHTML = '<option value="all">Todos los Años</option>';
            const currentYear = new Date().getFullYear();
            for (let i = 0; i < 5; i++) {
                const year = currentYear - i;
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }
        function unformatCurrency(value) {
            if (typeof value !== 'string') return parseFloat(value) || 0;
            return parseFloat(value.replace(/[^0-9]/g, '')) || 0;
        }
        function formatCurrencyInput(inputElement) {
            const value = unformatCurrency(inputElement.value);
            inputElement.value = value > 0 ? formatCurrency(value) : '';
        }
        function unformatCurrencyInput(inputElement) {
            const value = unformatCurrency(inputElement.value);
            inputElement.value = value > 0 ? value : '';
        }
        function showReportDateRangeModal() {
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            const now = new Date();
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            let monthOptions = '';
            for (let i = 0; i < 12; i++) {
                monthOptions += `<option value="${i}" ${i === now.getMonth() ? 'selected' : ''}>${monthNames[i]}</option>`;
            }

            let yearOptions = '';
            for (let i = 0; i < 5; i++) {
                const year = now.getFullYear() - i;
                yearOptions += `<option value="${year}">${year}</option>`;
            }

            modalContentWrapper.innerHTML = `
                <div class="bg-white rounded-lg p-6 shadow-xl max-w-lg w-full text-left">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Seleccionar Rango del Reporte</h2>
                        <button id="close-report-range-modal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                    </div>
                    <form id="report-range-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium">Mes de Inicio</label>
                                <select id="report-start-month" class="w-full p-2 border rounded-lg">${monthOptions}</select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Año de Inicio</label>
                                <select id="report-start-year" class="w-full p-2 border rounded-lg">${yearOptions}</select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium">Mes de Fin</label>
                                <select id="report-end-month" class="w-full p-2 border rounded-lg">${monthOptions}</select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Año de Fin</label>
                                <select id="report-end-year" class="w-full p-2 border rounded-lg">${yearOptions}</select>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Generar Reporte</button>
                    </form>
                </div>
            `;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('close-report-range-modal').addEventListener('click', hideModal);
            document.getElementById('report-range-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const startMonth = parseInt(document.getElementById('report-start-month').value);
                const startYear = parseInt(document.getElementById('report-start-year').value);
                const endMonth = parseInt(document.getElementById('report-end-month').value);
                const endYear = parseInt(document.getElementById('report-end-year').value);
                
                generateSummaryPDF(startYear, startMonth, endYear, endMonth);
                hideModal();
            });
        }
        function generateSummaryPDF(startYear, startMonth, endYear, endMonth) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const startDate = new Date(startYear, startMonth, 1);
            const endDate = new Date(endYear, endMonth + 1, 0);

            const rangeTitle = `${monthNames[startMonth]} ${startYear} - ${monthNames[endMonth]} ${endYear}`;
            doc.setFontSize(20);
            doc.text(`Reporte Financiero: ${rangeTitle}`, 105, 20, { align: "center" });

            // Calculate totals for the entire period
            const salesInRange = allRemisiones.flatMap(r => r.payments || []).filter(p => { const d = new Date(p.date); return d >= startDate && d <= endDate; }).reduce((sum, p) => sum + p.amount, 0);
            const expensesInRange = allGastos.filter(g => { const d = new Date(g.fecha); return d >= startDate && d <= endDate; }).reduce((sum, g) => sum + g.valorTotal, 0);
            const profitInRange = salesInRange - expensesInRange;

            const summaryData = [
                ['Ventas Totales en el Período', formatCurrency(salesInRange)],
                ['Gastos Totales en el Período', formatCurrency(expensesInRange)],
                ['Utilidad/Pérdida Total', formatCurrency(profitInRange)],
            ];
            
            doc.autoTable({
                startY: 30,
                head: [['Resumen del Período', 'Valor']],
                body: summaryData,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185] }
            });

            // Monthly breakdown
            const monthlyData = [];
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const monthName = monthNames[month];

                const monthlySales = allRemisiones.flatMap(r => r.payments || []).filter(p => { const d = new Date(p.date); return d.getMonth() === month && d.getFullYear() === year; }).reduce((sum, p) => sum + p.amount, 0);
                const monthlyExpenses = allGastos.filter(g => { const d = new Date(g.fecha); return d.getMonth() === month && d.getFullYear() === year; }).reduce((sum, g) => sum + g.valorTotal, 0);
                const monthlyProfit = monthlySales - monthlyExpenses;
                const endOfMonth = new Date(year, month + 1, 0);
                const carteraAtEndOfMonth = allRemisiones.filter(r => new Date(r.fechaRecibido) <= endOfMonth && r.estado !== 'Anulada').reduce((sum, r) => { const totalPagado = (r.payments || []).filter(p => new Date(p.date) <= endOfMonth).reduce((s, p) => s + p.amount, 0); const saldo = r.valorTotal - totalPagado; return sum + (saldo > 0 ? saldo : 0); }, 0);


                monthlyData.push([
                    `${monthName} ${year}`,
                    formatCurrency(monthlySales),
                    formatCurrency(monthlyExpenses),
                    formatCurrency(monthlyProfit),
                    formatCurrency(carteraAtEndOfMonth)
                ]);
                currentDate.setMonth(currentDate.getMonth() + 1);
            }

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10,
                head: [['Mes', 'Ventas', 'Gastos', 'Utilidad/Pérdida', 'Cartera al Cierre']],
                body: monthlyData,
                theme: 'striped',
                headStyles: { fillColor: [22, 160, 133] }
            });

            const accountBalances = { Efectivo: 0, Nequi: 0, Davivienda: 0 };
            allRemisiones.forEach(r => (r.payments || []).forEach(p => { if(accountBalances[p.method] !== undefined) accountBalances[p.method] += p.amount; }));
            allGastos.forEach(g => { if(accountBalances[g.fuentePago] !== undefined) accountBalances[g.fuentePago] -= g.valorTotal; });
            const totalCartera = allRemisiones.filter(r => r.estado !== 'Anulada').reduce((sum, r) => { const totalPagado = (r.payments || []).reduce((s, p) => s + p.amount, 0); const saldo = r.valorTotal - totalPagado; return sum + (saldo > 0 ? saldo : 0); }, 0);

            const accountData = [
                ['Efectivo', formatCurrency(accountBalances.Efectivo)],
                ['Nequi', formatCurrency(accountBalances.Nequi)],
                ['Davivienda', formatCurrency(accountBalances.Davivienda)],
                ['Cartera Total Pendiente', formatCurrency(totalCartera)],
            ];

            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10,
                head: [['Saldos y Totales Actuales', 'Valor']],
                body: accountData,
                theme: 'grid',
                headStyles: { fillColor: [41, 128, 185] }
            });

            doc.save(`Reporte-Financiero-${startYear}-${startMonth+1}_a_${endYear}-${endMonth+1}.pdf`);
        }
        function showPermissionsModal(user) {
            const modalContentWrapper = document.getElementById('modal-content-wrapper');
            const userPermissions = user.permissions || {};

            let permissionsHTML = ALL_MODULES.filter(m => m !== 'empleados').map(module => {
                const isChecked = userPermissions[module] || false;
                const capitalized = module.charAt(0).toUpperCase() + module.slice(1);
                return `
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" class="permission-checkbox h-4 w-4 rounded border-gray-300" data-module="${module}" ${isChecked ? 'checked' : ''}>
                        <span>${capitalized}</span>
                    </label>
                `;
            }).join('');

            modalContentWrapper.innerHTML = `
                <div class="bg-white rounded-lg p-6 shadow-xl max-w-lg w-full text-left">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Gestionar Permisos para ${user.nombre}</h2>
                        <button id="close-permissions-modal" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
                    </div>
                    <form id="permissions-form" class="space-y-4">
                        <input type="hidden" id="permission-user-id" value="${user.id}">
                        <div>
                            <label class="block text-sm font-medium">Rol</label>
                            <select id="role-select" class="w-full p-2 border rounded-lg mt-1 bg-white">
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Administrador</option>
                                <option value="facturador" ${user.role === 'facturador' ? 'selected' : ''}>Facturador</option>
                                <option value="planta" ${user.role === 'planta' ? 'selected' : ''}>Planta</option>
                                <option value="employee" ${user.role === 'employee' ? 'selected' : ''}>Empleado</option>
                            </select>
                        </div>
                        <div id="permissions-container">
                            <label class="block text-sm font-medium mb-2">Permisos de Módulos</label>
                            <div class="grid grid-cols-2 gap-2">
                                ${permissionsHTML}
                            </div>
                        </div>
                        <div class="flex justify-end pt-4">
                            <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Guardar Cambios</button>
                        </div>
                    </form>
                </div>
            `;

            const roleSelect = document.getElementById('role-select');
            const permissionsContainer = document.getElementById('permissions-container');
            const checkboxes = permissionsContainer.querySelectorAll('.permission-checkbox');

            function togglePermissionsUI(role) {
                if (role === 'admin') {
                    permissionsContainer.style.display = 'none';
                } else {
                    permissionsContainer.style.display = 'block';
                }
            }

            function setPermissionsForRole(role) {
                let newPermissions = {};
                if (role === 'facturador') {
                    newPermissions = { remisiones: true, clientes: true, items: false, colores: false, gastos: true, proveedores: true };
                } else if (role === 'employee') {
                    newPermissions = { remisiones: true, clientes: true, items: true, colores: true, gastos: false, proveedores: false };
                } else if (role === 'planta') {
                    newPermissions = { remisiones: true, clientes: false, items: false, colores: false, gastos: false, proveedores: false };
                }
                
                checkboxes.forEach(cb => {
                    cb.checked = newPermissions[cb.dataset.module] || false;
                });
            }

            roleSelect.addEventListener('change', (e) => {
                const newRole = e.target.value;
                togglePermissionsUI(newRole);
                setPermissionsForRole(newRole);
            });

            togglePermissionsUI(user.role);

            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('close-permissions-modal').addEventListener('click', hideModal);
            document.getElementById('permissions-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const userId = document.getElementById('permission-user-id').value;
                const newRole = document.getElementById('role-select').value;
                const newPermissions = {};
                
                checkboxes.forEach(cb => {
                    newPermissions[cb.dataset.module] = cb.checked;
                });
                
                showModalMessage("Guardando cambios...", true);
                try {
                    await updateDoc(doc(db, "users", userId), {
                        role: newRole,
                        permissions: newPermissions
                    });
                    hideModal();
                    showModalMessage("Permisos actualizados.", false, 2000);
                } catch (error) {
                    console.error("Error al actualizar permisos:", error);
                    showModalMessage("Error al guardar los cambios.");
                }
            });
        }

    </script>
</body>
</html>
